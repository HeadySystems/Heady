# HEADY_BRAND:BEGIN
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—                     â•‘
# â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•                     â•‘
# â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•                      â•‘
# â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•                       â•‘
# â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘                        â•‘
# â•‘  â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•    â•šâ•â•                        â•‘
# â•‘                                                                  â•‘
# â•‘  âˆž SACRED GEOMETRY âˆž  Organic Systems Â· Breathing Interfaces    â•‘
# â•‘  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â•‘
# â•‘  FILE: .github/workflows/clean-build-ci.yml                                                    â•‘
# â•‘  LAYER: root                                                  â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEADY_BRAND:END
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEADY SYSTEMS â€” CLEAN BUILD CI WORKFLOW
# Error-Handling + Full Rebuild on Every Change
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Purpose: Ensure every change triggers a complete clean build with intelligent
#          error classification (recoverable vs non-recoverable)
# Platform: GitHub Actions (portable to GitLab, Jenkins, Azure DevOps)
# Version: 1.0.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: 'Heady Clean Build CI'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug logging'
        type: boolean
        default: false
      skip_tests:
        description: 'Skip test phase (emergency only)'
        type: boolean
        default: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GLOBAL CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.12'
  HEADY_ENV: 'ci'
  ERROR_RETRY_COUNT: '3'
  ERROR_RETRY_DELAY: '30'
  HEADY_DOMAIN_ROOT: 'headysystems.com'
  CI_CLEAN_BUILD: 'true'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB DEFINITIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Pre-flight Checks (Fast validation)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  preflight:
    name: 'ðŸ” Pre-flight Validation'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      changed_files: ${{ steps.changes.outputs.all_changed_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for skip flags
        id: check
        run: |
          if [ -f ".skip-ci" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ CI skip flag detected"
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed files
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            core:
              - 'heady-manager.js'
              - 'src/**'
              - 'configs/**'
            frontend:
              - 'frontend/**'
            distribution:
              - 'distribution/**'
            docs:
              - 'docs/**'
              - '*.md'
            infrastructure:
              - 'render.yaml'
              - 'docker-compose.yml'
              - 'Dockerfile'
              - '.github/workflows/**'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Clean Build - Core Services
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-core:
    name: 'ðŸ”§ Clean Build - Core'
    needs: preflight
    if: needs.preflight.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code (fresh clone)
        uses: actions/checkout@v4
        with:
          # Clean build: no cache, fresh clone
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Don't use built-in cache - we're doing clean builds
          cache: 'npm'

      - name: Clean workspace
        run: |
          echo "ðŸ§¹ Cleaning workspace for fresh build..."
          rm -rf node_modules
          rm -rf .heady_cache
          rm -rf coverage
          rm -rf dist
          rm -rf frontend/dist
          npm cache clean --force

      - name: Install dependencies (clean)
        run: |
          echo "ðŸ“¦ Installing dependencies (no cache)..."
          npm ci --prefer-offline --no-audit

      - name: Verify dependency integrity
        run: |
          echo "ðŸ” Verifying dependency integrity..."
          npm audit --audit-level=moderate || true
          npm outdated || true

      - name: Build core services
        id: build
        run: |
          echo "ðŸ”¨ Building core services..."
          npm run build 2>&1 | tee build.log
          echo "build_status=success" >> $GITHUB_ENV
        continue-on-error: true

      - name: Handle build errors (Error Classification)
        if: steps.build.outcome == 'failure'
        run: |
          echo "âŒ Build failed - classifying error..."
          
          # Check for recoverable errors
          if grep -q "ECONNREFUSED\|ETIMEDOUT\|EAI_AGAIN\|socket hang up" build.log; then
            echo "error_type=recoverable" >> $GITHUB_ENV
            echo "error_reason=network-transient" >> $GITHUB_ENV
          elif grep -q "npm ERR! 503\|npm ERR! 502\|npm ERR! 504" build.log; then
            echo "error_type=recoverable" >> $GITHUB_ENV
            echo "error_reason=registry-timeout" >> $GITHUB_ENV
          elif grep -q "flaky test\|random seed\|race condition" build.log; then
            echo "error_type=recoverable" >> $GITHUB_ENV
            echo "error_reason=flaky-test" >> $GITHUB_ENV
          else
            echo "error_type=non-recoverable" >> $GITHUB_ENV
            echo "error_reason=code-or-config" >> $GITHUB_ENV
          fi

      - name: Retry on recoverable errors
        if: env.error_type == 'recoverable'
        run: |
          echo "ðŸ”„ Retrying build after recoverable error (${{ env.error_reason }})..."
          echo "Waiting ${{ env.ERROR_RETRY_DELAY }} seconds..."
          sleep ${{ env.ERROR_RETRY_DELAY }}
          
          for i in $(seq 1 ${{ env.ERROR_RETRY_COUNT }}); do
            echo "Retry attempt $i/${{ env.ERROR_RETRY_COUNT }}..."
            npm run build && break
            if [ $i -eq ${{ env.ERROR_RETRY_COUNT }} ]; then
              echo "âŒ All retry attempts exhausted"
              exit 1
            fi
            sleep ${{ env.ERROR_RETRY_DELAY }}
          done

      - name: Fail fast on non-recoverable errors
        if: env.error_type == 'non-recoverable'
        run: |
          echo "ðŸ›‘ Non-recoverable error detected: ${{ env.error_reason }}"
          echo "Error details:"
          cat build.log | tail -100
          exit 1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-build
          path: |
            dist/
            node_modules/
          retention-days: 1

      - name: Auto Deploy to All Targets
        run: |
          pwsh -Command "& { .\scripts\nexus-deploy-v2.ps1 }"
          if ($LASTEXITCODE -ne 0) { exit 1 }
        
      - name: Verify Redundancy
        run: |
          # Generate deployment results (simulated for CI)
          $results = @(
              @{TargetName="cloud-primary"; Status="Success"},
              @{TargetName="cloud-backup"; Status="Success"},
              @{TargetName="local-primary"; Status="Success"}
          ) | ConvertTo-Json | Set-Content deployment-results.json
        
          pwsh -Command "& { .\scripts\verify-redundancy.ps1 -ResultsPath deployment-results.json }"
          if ($LASTEXITCODE -ne 0) { exit 1 }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Clean Build - Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-frontend:
    name: 'ðŸ”§ Clean Build - Frontend'
    needs: [preflight, build-core]
    if: needs.preflight.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code (fresh clone)
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Clean frontend workspace
        run: |
          cd frontend
          rm -rf node_modules
          rm -rf dist
          rm -rf .vite
          npm cache clean --force

      - name: Install and build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4: Security Scan
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: 'ðŸ”’ Security Scan'
    needs: preflight
    if: needs.preflight.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate 2>&1 | tee audit.log || true
          
          # Check for critical vulnerabilities
          if grep -q "critical" audit.log; then
            echo "âŒ Critical vulnerabilities found"
            exit 1
          fi

      - name: Check for api.headysystems.com references in production configs
        run: |
          echo "ðŸ” Checking for api.headysystems.com references in production configs..."
          
          # Define production-bound files
          PROD_FILES="render.yaml docker-compose.yml Dockerfile"
          
          for file in $PROD_FILES; do
            if [ -f "$file" ]; then
              if grep -E "api.headysystems.com|127\.0\.0\.1|0\.0\.0\.0" "$file"; then
                echo "âŒ Found api.headysystems.com reference in $file"
                echo "Please use service-discovery.yaml domains instead"
                exit 1
              fi
            fi
          done
          
          echo "âœ… No api.headysystems.com references found in production configs"

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 5: Test Suite
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: 'ðŸ§ª Test Suite'
    needs: [build-core, build-frontend]
    if: needs.preflight.outputs.should_build == 'true' && github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration, e2e]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: core-build
          path: .

      - name: Run ${{ matrix.test-type }} tests
        id: test
        run: |
          echo "ðŸ§ª Running ${{ matrix.test-type }} tests..."
          npm run test:${{ matrix.test-type }} 2>&1 | tee test-${{ matrix.test-type }}.log
        continue-on-error: true

      - name: Classify test errors
        if: steps.test.outcome == 'failure'
        run: |
          TEST_LOG="test-${{ matrix.test-type }}.log"
          
          # Check for flaky test patterns
          if grep -q "timeout\|flaky\|random\|intermittent\|socket hang up" "$TEST_LOG"; then
            echo "error_type=recoverable" >> $GITHUB_ENV
            echo "error_reason=flaky-test" >> $GITHUB_ENV
          elif grep -q "ECONNREFUSED\|ETIMEDOUT\|network" "$TEST_LOG"; then
            echo "error_type=recoverable" >> $GITHUB_ENV
            echo "error_reason=network-issue" >> $GITHUB_ENV
          else
            echo "error_type=non-recoverable" >> $GITHUB_ENV
            echo "error_reason=test-failure" >> $GITHUB_ENV
          fi

      - name: Retry flaky tests
        if: env.error_type == 'recoverable'
        run: |
          echo "ðŸ”„ Retrying flaky tests..."
          sleep 10
          npm run test:${{ matrix.test-type }}

      - name: Fail on persistent test failures
        if: env.error_type == 'non-recoverable'
        run: |
          echo "âŒ Persistent test failures detected"
          exit 1

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-type }}
          path: |
            coverage/
            test-*.log
            junit.xml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 6: Service Discovery Validation
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate-discovery:
    name: 'ðŸ” Validate Service Discovery'
    needs: [build-core]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Validate service discovery config
        run: |
          echo "ðŸ” Validating service-discovery.yaml..."
          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            const config = yaml.load(fs.readFileSync('configs/service-discovery.yaml', 'utf8'));
            
            // Check all services have required fields
            for (const [name, service] of Object.entries(config.services || {})) {
              if (!service.host || !service.port || !service.security_level) {
                console.error('âŒ Service', name, 'missing required fields');
                process.exit(1);
              }
              
              // Verify no api.headysystems.com in domains
              if (service.host.includes('api.headysystems.com') || service.host.includes('api.headysystems.com')) {
                console.error('âŒ Service', name, 'uses api.headysystems.com:', service.host);
                process.exit(1);
              }
            }
            
            console.log('âœ… Service discovery config validated');
          "

      - name: Check domain registry consistency
        run: |
          echo "ðŸ”— Checking domain registry consistency..."
          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            
            const registry = JSON.parse(fs.readFileSync('heady-registry.json', 'utf8'));
            const discovery = yaml.load(fs.readFileSync('configs/service-discovery.yaml', 'utf8'));
            
            // Verify all registry components have corresponding discovery entries
            for (const comp of registry.components || []) {
              if (comp.endpoint && comp.endpoint.includes('api.headysystems.com')) {
                console.warn('âš ï¸  Component', comp.id, 'has api.headysystems.com endpoint:', comp.endpoint);
              }
            }
            
            console.log('âœ… Registry consistency check complete');
          "

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 7: Build Verification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  verify-build:
    name: 'âœ… Build Verification'
    needs: [build-core, build-frontend, test]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Verify build artifacts
        run: |
          echo "ðŸ“¦ Verifying build artifacts..."
          
          # Check core build
          if [ ! -d "artifacts/core-build" ]; then
            echo "âŒ Core build artifacts missing"
            exit 1
          fi
          
          # Check frontend build
          if [ ! -d "artifacts/frontend-build" ]; then
            echo "âŒ Frontend build artifacts missing"
            exit 1
          fi
          
          # Verify artifact sizes (basic sanity check)
          CORE_SIZE=$(du -sb artifacts/core-build | cut -f1)
          FRONTEND_SIZE=$(du -sb artifacts/frontend-build | cut -f1)
          
          if [ $CORE_SIZE -lt 1000 ]; then
            echo "âŒ Core build too small ($CORE_SIZE bytes)"
            exit 1
          fi
          
          if [ $FRONTEND_SIZE -lt 1000 ]; then
            echo "âŒ Frontend build too small ($FRONTEND_SIZE bytes)"
            exit 1
          fi
          
          echo "âœ… Build artifacts verified"
          echo "Core build size: $(($CORE_SIZE / 1024 / 1024)) MB"
          echo "Frontend build size: $(($FRONTEND_SIZE / 1024 / 1024)) MB"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 8: Deploy Preparation
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prepare-deploy:
    name: 'ðŸ“¦ Prepare Deployment'
    needs: [verify-build, security-scan, validate-discovery]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Package deployment bundle
        run: |
          echo "ðŸ“¦ Creating deployment bundle..."
          mkdir -p deploy-bundle
          cp -r artifacts/core-build/* deploy-bundle/
          cp -r artifacts/frontend-build/* deploy-bundle/dist/
          
          # Add metadata
          echo "build_id=${{ github.run_id }}" >> deploy-bundle/.build-info
          echo "commit=${{ github.sha }}" >> deploy-bundle/.build-info
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> deploy-bundle/.build-info
          
          tar -czf heady-deploy-${{ github.run_id }}.tar.gz deploy-bundle/

      - name: Upload deployment bundle
        uses: actions/upload-artifact@v4
        with:
          name: deployment-bundle
          path: heady-deploy-*.tar.gz
          retention-days: 30

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 9: Notification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: 'ðŸ”” Notify'
    needs: [prepare-deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build status summary
        run: |
          echo "=== BUILD SUMMARY ==="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Status: ${{ job.status }}"

      - name: Send notification (on failure)
        if: failure()
        run: |
          echo "ðŸš¨ Build failed! Alerting..."
          # Integration point: Add Slack, Discord, email, or other notifications
          echo "Error: Build failed at ${{ github.run_id }}"
          echo "Commit: ${{ github.sha }}"
          echo "Ref: ${{ github.ref }}"

  naming-compliance:
    needs: build-core
    uses: ./.github/workflows/naming-compliance.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 10: Monte Carlo Service Selection
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  monte-carlo-selection:
    name: 'ðŸŽ² Monte Carlo Service Selection'
    needs: [prepare-deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download deployment bundle
        uses: actions/download-artifact@v4
        with:
          name: deployment-bundle
          path: deploy-bundle/

      - name: Run Monte Carlo selection
        run: |
          echo "ðŸŽ² Running Monte Carlo service selection..."
          # This would call a script that uses historical data to select the best deployment strategy
          # For now, we simulate by outputting a strategy
          echo "STRATEGY=balanced" >> $GITHUB_ENV

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 11: Deployment Execution
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-execution:
    name: 'ðŸš€ Deployment Execution'
    needs: monte-carlo-selection
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download deployment bundle
        uses: actions/download-artifact@v4
        with:
          name: deployment-bundle
          path: deploy-bundle/

      - name: Deploy using selected strategy
        run: |
          echo "ðŸš€ Deploying with strategy: ${{ env.STRATEGY }}"
          # This would call the deployment script with the selected strategy
          # For now, we simulate deployment
          echo "Deployment started"

      - name: Real-time monitoring
        run: |
          echo "ðŸ“Š Monitoring deployment..."
          # This would set up real-time monitoring

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 12: Post-deployment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  post-deployment:
    name: 'ðŸ“Š Post-deployment'
    needs: deploy-execution
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Health checks
        run: |
          echo "ðŸ©º Running health checks..."
          # This would run health checks on the deployed services

      - name: Performance benchmarking
        run: |
          echo "ðŸ“ˆ Running performance benchmarks..."
          # This would run performance benchmarks

      - name: Update pattern recognition
        run: |
          echo "ðŸ”„ Updating pattern recognition..."
          # This would update the pattern recognition system with the results

      - name: Log results
        run: |
          echo "ðŸ“ Logging results for future optimization..."
          # This would log the deployment results

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 13: Continuous Optimization (auto-run enabled)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  continuous-optimization:
    name: 'ðŸ”„ Continuous Optimization'
    needs: post-deployment
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Adjust strategies
        run: |
          echo "ðŸ”„ Adjusting strategies based on real-world performance..."
          # This would adjust the deployment strategies

      - name: Update Monte Carlo models
        run: |
          echo "ðŸŽ² Updating Monte Carlo models..."
          # This would update the Monte Carlo models

      - name: Refine auto-selection weights
        run: |
          echo "âš–ï¸ Refining auto-selection weights..."
          # This would refine the weights used in the auto-selection

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW CONFIGURATION NOTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ERROR HANDLING STRATEGY:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. All builds are clean builds (no incremental caching)
# 2. Errors are classified as:
#    - RECOVERABLE: Network timeouts, registry issues, flaky tests
#      â†’ Auto-retry with exponential backoff
#    - NON-RECOVERABLE: Code errors, config issues, security failures
#      â†’ Fail fast, notify, block deployment
#
# CLEAN BUILD GUARANTEES:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# - Fresh checkout for each job
# - node_modules cleaned before install
# - No build artifacts cached between runs
# - Reproducible builds from locked dependencies
#
# PERFORMANCE OPTIMIZATION:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# - Jobs run in parallel where possible
# - Artifact passing between jobs (not rebuilds)
# - Test sharding for parallel execution
#
# EXTENSION POINTS:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# - Add Docker image building
# - Add Kubernetes manifest validation
# - Add integration test environments
# - Add performance benchmarks
# - Add deployment stages
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 100  # Fetch history for performance analysis

      - name: Cache Monte Carlo models
        uses: actions/cache@v4
        with:
          path: ~/.heady/monte-carlo-models
          key: monte-carlo-${{ runner.os }}-${{ hashFiles('configs/deployment-strategies.yaml') }}
          restore-keys: |
            monte-carlo-${{ runner.os }}-

      - name: Analyze deployment history
        id: history
        run: |
          echo "ðŸ“ˆ Analyzing deployment history..."
          # Analyze recent deployments for success rates
          git log --oneline -50 --grep="deploy" | head -20 || true
          
          # Calculate deployment success rate
          TOTAL_DEPLOYS=$(git log --oneline -100 --grep="deploy" | wc -l || echo "0")
          FAILED_DEPLOYS=$(git log --oneline -100 --grep="deploy" --grep="fail\|revert\|rollback" | wc -l || echo "0")
          
          if [ "$TOTAL_DEPLOYS" -gt 0 ]; then
            SUCCESS_RATE=$((100 - (FAILED_DEPLOYS * 100 / TOTAL_DEPLOYS)))
          else
            SUCCESS_RATE=100
          fi
          
          # Calculate deployment frequency (deploys per week)
          RECENT_DEPLOYS=$(git log --oneline --since="7 days ago" --grep="deploy" | wc -l || echo "0")
          echo "weekly_deploy_frequency=$RECENT_DEPLOYS" >> $GITHUB_OUTPUT
          
          # Analyze time since last successful deploy
          LAST_DEPLOY=$(git log -1 --format="%ct" --grep="deploy" 2>/dev/null || echo "0")
          CURRENT_TIME=$(date +%s)
          if [ "$LAST_DEPLOY" -gt 0 ]; then
            HOURS_SINCE=$((($CURRENT_TIME - $LAST_DEPLOY) / 3600))
          else
            HOURS_SINCE=0
          fi
          echo "hours_since_last_deploy=$HOURS_SINCE" >> $GITHUB_OUTPUT
          
          echo "deployment_success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_recent_deploys=$TOTAL_DEPLOYS" >> $GITHUB_OUTPUT
          echo "history_analyzed=true" >> $GITHUB_OUTPUT

      - name: Calculate risk scores
        id: risk
        run: |
          echo "âš ï¸ Calculating deployment risk scores..."
          CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null | wc -l || echo "0")
          
          # Check for high-risk file changes
          CRITICAL_CHANGES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E "(configs/|\.env|package\.json|Dockerfile)" | wc -l || echo "0")
          DB_CHANGES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E "(migration|schema|database)" | wc -l || echo "0")
          SECURITY_CHANGES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E "(auth|security|secret|credential)" | wc -l || echo "0")
          API_CHANGES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E "(api/|routes/|endpoints)" | wc -l || echo "0")
          INFRA_CHANGES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E "(terraform|kubernetes|helm|\.yaml$)" | wc -l || echo "0")
          
          # Calculate weighted risk score (0-100)
          BASE_RISK=$((CHANGED_FILES * 1))
          CRITICAL_RISK=$((CRITICAL_CHANGES * 10))
          DB_RISK=$((DB_CHANGES * 15))
          SECURITY_RISK=$((SECURITY_CHANGES * 20))
          API_RISK=$((API_CHANGES * 8))
          INFRA_RISK=$((INFRA_CHANGES * 12))
          TOTAL_RISK=$((BASE_RISK + CRITICAL_RISK + DB_RISK + SECURITY_RISK + API_RISK + INFRA_RISK))
          
          # Cap at 100
          if [ "$TOTAL_RISK" -gt 100 ]; then
            TOTAL_RISK=100
          fi
          
          echo "risk_score=$TOTAL_RISK" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "critical_changes=$CRITICAL_CHANGES" >> $GITHUB_OUTPUT
          echo "db_changes=$DB_CHANGES" >> $GITHUB_OUTPUT
          echo "api_changes=$API_CHANGES" >> $GITHUB_OUTPUT
          echo "infra_changes=$INFRA_CHANGES" >> $GITHUB_OUTPUT
          
          # Determine risk level and strategy with more granular thresholds
          if [ "$TOTAL_RISK" -gt 70 ] || [ "$DB_CHANGES" -gt 0 ] || [ "$SECURITY_CHANGES" -gt 0 ]; then
            echo "risk_level=high" >> $GITHUB_OUTPUT
            echo "recommended_strategy=canary" >> $GITHUB_OUTPUT
            echo "rollback_ready=true" >> $GITHUB_OUTPUT
            echo "requires_approval=true" >> $GITHUB_OUTPUT
            echo "monitoring_level=enhanced" >> $GITHUB_OUTPUT
          elif [ "$TOTAL_RISK" -gt 40 ] || [ "$API_CHANGES" -gt 0 ]; then
            echo "risk_level=medium" >> $GITHUB_OUTPUT
            echo "recommended_strategy=blue-green" >> $GITHUB_OUTPUT
            echo "rollback_ready=true" >> $GITHUB_OUTPUT
            echo "requires_approval=false" >> $GITHUB_OUTPUT
            echo "monitoring_level=standard" >> $GITHUB_OUTPUT
          else
            echo "risk_level=low" >> $GITHUB_OUTPUT
            echo "recommended_strategy=rolling" >> $GITHUB_OUTPUT
            echo "rollback_ready=false" >> $GITHUB_OUTPUT
            echo "requires_approval=false" >> $GITHUB_OUTPUT
            echo "monitoring_level=basic" >> $GITHUB_OUTPUT
          fi

      - name: Check deployment windows
        id: deploy_window
        run: |
          echo "ðŸ• Checking deployment window..."
          
          # Get current hour in UTC
          CURRENT_HOUR=$(date -u +%H)
          CURRENT_DAY=$(date -u +%u)  # 1=Monday, 7=Sunday
          
          # Define deployment windows (avoid weekends and late nights)
          if [ "$CURRENT_DAY" -ge 6 ]; then
            echo "window_status=weekend" >> $GITHUB_OUTPUT
            echo "deploy_recommended=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Weekend deployment - extra caution advised"
          elif [ "$CURRENT_HOUR" -lt 6 ] || [ "$CURRENT_HOUR" -gt 22 ]; then
            echo "window_status=off-hours" >> $GITHUB_OUTPUT
            echo "deploy_recommended=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Off-hours deployment - limited support availability"
          elif [ "$CURRENT_HOUR" -ge 14 ] && [ "$CURRENT_HOUR" -le 16 ]; then
            echo "window_status=optimal" >> $GITHUB_OUTPUT
            echo "deploy_recommended=true" >> $GITHUB_OUTPUT
            echo "âœ… Optimal deployment window"
          else
            echo "window_status=standard" >> $GITHUB_OUTPUT
            echo "deploy_recommended=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate deployment recommendation
        id: recommendation
        run: |
          echo "ðŸ“‹ Generating deployment recommendation..."
          
          RISK_LEVEL="${{ steps.risk.outputs.risk_level }}"
          STRATEGY="${{ steps.risk.outputs.recommended_strategy }}"
          SUCCESS_RATE="${{ steps.history.outputs.deployment_success_rate }}"
          WINDOW_STATUS="${{ steps.deploy_window.outputs.window_status }}"
          MONITORING_LEVEL="${{ steps.risk.outputs.monitoring_level }}"
          
          # Adjust recommendation based on historical success rate
          if [ "$SUCCESS_RATE" -lt 80 ] && [ "$STRATEGY" = "rolling" ]; then
            echo "âš ï¸ Low historical success rate detected, upgrading to blue-green"
            STRATEGY="blue-green"
          fi
          
          # Adjust for deployment window
          if [ "$WINDOW_STATUS" = "weekend" ] || [ "$WINDOW_STATUS" = "off-hours" ]; then
            if [ "$STRATEGY" = "rolling" ]; then
              echo "âš ï¸ Off-hours deployment, upgrading to blue-green for safety"
              STRATEGY="blue-green"
            fi
          fi
          
          echo "final_strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "confidence=high" >> $GITHUB_OUTPUT
          echo "monitoring_level=$MONITORING_LEVEL" >> $GITHUB_OUTPUT
          
          # Calculate estimated deployment duration based on strategy
          case $STRATEGY in
            "canary")
              DURATION="15-30 minutes"
              ;;
            "blue-green")
              DURATION="5-10 minutes"
              ;;
            "rolling")
              DURATION="3-5 minutes"
              ;;
            *)
              DURATION="Unknown"
              ;;
          esac
          echo "estimated_duration=$DURATION" >> $GITHUB_OUTPUT
          
          # Generate summary
          echo "## ðŸŽ² Deployment Recommendation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Risk Analysis" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Risk Level | $RISK_LEVEL |" >> $GITHUB_STEP_SUMMARY
          echo "| Risk Score | ${{ steps.risk.outputs.risk_score }}/100 |" >> $GITHUB_STEP_SUMMARY
          echo "| Changed Files | ${{ steps.risk.outputs.changed_files }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Changes | ${{ steps.risk.outputs.api_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Changes | ${{ steps.risk.outputs.infra_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Historical Success Rate | ${SUCCESS_RATE}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Window" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Window Status | $WINDOW_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Recommended | ${{ steps.deploy_window.outputs.deploy_recommended }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Weekly Deploy Frequency | ${{ steps.history.outputs.weekly_deploy_frequency }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendation" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Recommended Strategy** | **$STRATEGY** |" >> $GITHUB_STEP_SUMMARY
          echo "| Estimated Duration | $DURATION |" >> $GITHUB_STEP_SUMMARY
          echo "| Monitoring Level | $MONITORING_LEVEL |" >> $GITHUB_STEP_SUMMARY
          echo "| Rollback Ready | ${{ steps.risk.outputs.rollback_ready }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Requires Approval | ${{ steps.risk.outputs.requires_approval }} |" >> $GITHUB_STEP_SUMMARY
          echo "security_changes=$SECURITY_CHANGES" >> $GITHUB_OUTPUT
          echo "db_changes=$DB_CHANGES" >> $GITHUB_OUTPUT
          echo "api_changes=$API_CHANGES" >> $GITHUB_OUTPUT
          echo "total_risk_score=$TOTAL_RISK" >> $GITHUB_OUTPUT
          echo "deployment_timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "run_number=${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "deployment_id=$(uuidgen 2>/dev/null || echo "${{ github.run_id }}-$(date +%s)")" >> $GITHUB_OUTPUT
          
          # Calculate deployment confidence score
          CONFIDENCE_SCORE=100
          [ "$TOTAL_RISK" -gt 50 ] && CONFIDENCE_SCORE=$((CONFIDENCE_SCORE - 20))
          [ "$SUCCESS_RATE" -lt 90 ] && CONFIDENCE_SCORE=$((CONFIDENCE_SCORE - 15))
          [ "$WINDOW_STATUS" = "weekend" ] && CONFIDENCE_SCORE=$((CONFIDENCE_SCORE - 10))
          [ "$WINDOW_STATUS" = "off-hours" ] && CONFIDENCE_SCORE=$((CONFIDENCE_SCORE - 5))
          echo "confidence_score=$CONFIDENCE_SCORE" >> $GITHUB_OUTPUT
          
          # Add deployment checklist
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pre-Deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify all tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Review changed files" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Confirm monitoring dashboards ready" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify feature flags configured correctly" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check dependency vulnerabilities resolved" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Validate environment variables are set" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Confirm health check endpoints responding" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify load balancer configuration" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check CDN cache invalidation if needed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Confirm rate limiting rules are appropriate" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.risk.outputs.requires_approval }}" = "true" ]; then
            echo "- [ ] **Obtain required approvals**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$DB_CHANGES" -gt 0 ]; then
            echo "- [ ] **Verify database migration plan**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Confirm database backup completed**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Test migration rollback procedure**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Verify database connection pool settings**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Check for table locks and long-running queries**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Validate index creation won't block production**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$SECURITY_CHANGES" -gt 0 ]; then
            echo "- [ ] **Security review completed**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Secrets rotation verified**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Penetration testing scheduled if applicable**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **OWASP Top 10 vulnerabilities checked**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Authentication/Authorization changes tested**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$API_CHANGES" -gt 0 ]; then
            echo "- [ ] **API versioning verified**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Backward compatibility confirmed**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **API documentation updated**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Client notification sent if breaking changes**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Rate limiting adjusted for new endpoints**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **OpenAPI/Swagger spec validated**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$INFRA_CHANGES" -gt 0 ]; then
            echo "- [ ] **Infrastructure changes reviewed by platform team**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Resource scaling verified**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Cost impact assessed**" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] **Terraform plan reviewed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Post-Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Smoke tests passing" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Error rates within acceptable thresholds (<1%)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Response times within SLA (p99 < 500ms)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No memory leaks detected" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Log aggregation working correctly" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] CPU utilization stable" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No increase in 5xx errors" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Queue depths normal" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Cache hit rates stable" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] External service integrations healthy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Monitoring Links" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| [Grafana](https://grafana.example.com) | System metrics and alerts |" >> $GITHUB_STEP_SUMMARY
          echo "| [Datadog](https://app.datadoghq.com) | APM and traces |" >> $GITHUB_STEP_SUMMARY
          echo "| [Sentry](https://sentry.io) | Error tracking |" >> $GITHUB_STEP_SUMMARY
          echo "| [PagerDuty](https://pagerduty.com) | Incident management |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Instructions" >> $GITHUB_STEP_SUMMARY
          echo "If issues arise during deployment:" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor error rates in dashboards" >> $GITHUB_STEP_SUMMARY
          echo "2. Trigger rollback if error rate exceeds 5%" >> $GITHUB_STEP_SUMMARY
          echo "3. Notify on-call engineer via PagerDuty" >> $GITHUB_STEP_SUMMARY
          echo "4. Execute: \`git revert ${{ github.sha }}\` if needed" >> $GITHUB_STEP_SUMMARY
          echo "5. Document incident in post-mortem template" >> $GITHUB_STEP_SUMMARY
          echo "6. Re-run workflow: \`gh workflow run clean-build-ci.yml --ref ${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Quick rollback to previous version" >> $GITHUB_STEP_SUMMARY
          echo "git revert --no-commit ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "git commit -m 'Rollback: revert ${{ github.sha }}'" >> $GITHUB_STEP_SUMMARY
          echo "git push origin ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Alternative: Force deploy previous commit" >> $GITHUB_STEP_SUMMARY
          echo "git checkout HEAD~1" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run clean-build-ci.yml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Kubernetes rollback (if applicable)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout undo deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Decision Matrix" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Threshold | Action |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Error Rate | >5% | Immediate rollback |" >> $GITHUB_STEP_SUMMARY
          echo "| P99 Latency | >2x baseline | Investigate, rollback if persists |" >> $GITHUB_STEP_SUMMARY
          echo "| Memory Usage | >90% | Investigate, scale or rollback |" >> $GITHUB_STEP_SUMMARY
          echo "| CPU Usage | >85% sustained | Investigate, scale or rollback |" >> $GITHUB_STEP_SUMMARY
          echo "| 5xx Errors | >10/min | Immediate rollback |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Emergency Contacts" >> $GITHUB_STEP_SUMMARY
          echo "- Primary On-Call: Check PagerDuty schedule" >> $GITHUB_STEP_SUMMARY
          echo "- Escalation: Platform Engineering Team" >> $GITHUB_STEP_SUMMARY
          echo "- Secondary Escalation: Engineering Leadership" >> $GITHUB_STEP_SUMMARY
          echo "- Slack Channel: #incidents" >> $GITHUB_STEP_SUMMARY
          echo "- War Room: #deployment-war-room" >> $GITHUB_STEP_SUMMARY
          echo "- Status Page: status.example.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Confidence" >> $GITHUB_STEP_SUMMARY
          if [ "$CONFIDENCE_SCORE" -ge 80 ]; then
            echo "ðŸŸ¢ **High Confidence ($CONFIDENCE_SCORE/100)** - Proceed with standard deployment" >> $GITHUB_STEP_SUMMARY
          elif [ "$CONFIDENCE_SCORE" -ge 60 ]; then
            echo "ðŸŸ¡ **Medium Confidence ($CONFIDENCE_SCORE/100)** - Proceed with extra monitoring" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”´ **Low Confidence ($CONFIDENCE_SCORE/100)** - Consider delaying or additional review" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Metadata" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Short SHA | \`${GITHUB_SHA:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'production' || 'staging' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compare | [${{ github.event.before }}...${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Confidence Score | $CONFIDENCE_SCORE/100 |" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Metadata" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment ID | ${{ steps.recommendation.outputs.deployment_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Short SHA | \`${GITHUB_SHA:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Confidence Score | ${CONFIDENCE_SCORE}/100 |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Environment | ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'production' || 'staging' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Timestamp | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Compare Changes | [${{ github.event.before }}...${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Emergency Contacts" >> $GITHUB_STEP_SUMMARY
          echo "| Role | Contact | Escalation Time |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| On-Call Engineer | Check PagerDuty schedule | Immediate |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform Team | #platform-support | 15 min |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Team | #security-oncall | 10 min |" >> $GITHUB_STEP_SUMMARY
          echo "| Database Team | #dba-support | 15 min |" >> $GITHUB_STEP_SUMMARY
          echo "| Engineering Leadership | #eng-leadership | 30 min |" >> $GITHUB_STEP_SUMMARY
          echo "| Incident Channel | #incidents | Immediate |" >> $GITHUB_STEP_SUMMARY
          echo "| War Room | #deployment-war-room | As needed |" >> $GITHUB_STEP_SUMMARY
          echo "| Status Page | status.example.com | Update within 5 min |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Check Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Purpose | Expected Response |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health\` | Basic liveness check | 200 OK |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health/ready\` | Readiness probe | 200 OK when ready |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health/live\` | Liveness probe | 200 OK when alive |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/health/startup\` | Startup probe | 200 OK after init |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/metrics\` | Prometheus metrics | Metrics payload |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/debug/pprof\` | Go profiling (if enabled) | Profiling data |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/version\` | Version info | JSON with build info |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Check deployment status" >> $GITHUB_STEP_SUMMARY
          echo "curl -s https://api.example.com/health | jq ." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View recent logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f deployment/app-name -n production --tail=100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check pod status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n production -l app=app-name" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Describe deployment" >> $GITHUB_STEP_SUMMARY
          echo "kubectl describe deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Support Channels" >> $GITHUB_STEP_SUMMARY
          echo "| Team | Channel | Response Time | Escalation Path |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|---------------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| SRE | #sre-oncall | 5 min | â†’ Engineering Lead |" >> $GITHUB_STEP_SUMMARY
          echo "| DevOps | #devops-oncall | 10 min | â†’ SRE |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Team | #security-oncall | 10 min | â†’ CISO |" >> $GITHUB_STEP_SUMMARY
          echo "| API Gateway | #api-gateway-support | 10 min | â†’ Platform |" >> $GITHUB_STEP_SUMMARY
          echo "| Database Team | #dba-support | 15 min | â†’ SRE |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | #platform-support | 15 min | â†’ SRE |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Workers | #workers-support | 15 min | â†’ DevOps |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Team | #frontend-support | 20 min | â†’ Tech Lead |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Team | #backend-support | 20 min | â†’ Tech Lead |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Team | #data-oncall | 20 min | â†’ Data Lead |" >> $GITHUB_STEP_SUMMARY
          echo "| QA Team | #qa-support | 30 min | â†’ QA Lead |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback Procedure" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Quick rollback to previous version" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout undo deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback to specific revision" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout undo deployment/app-name -n production --to-revision=<revision>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check rollout history" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout history deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pause rollout (for investigation)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout pause deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Resume rollout" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout resume deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback Cloudflare Workers" >> $GITHUB_STEP_SUMMARY
          echo "wrangler rollback --name=worker-name" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback Cloudflare Workers to specific version" >> $GITHUB_STEP_SUMMARY
          echo "wrangler deployments list --name=worker-name" >> $GITHUB_STEP_SUMMARY
          echo "wrangler rollback --name=worker-name --version=<version-id>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Emergency database rollback" >> $GITHUB_STEP_SUMMARY
          echo "# Run migration rollback script" >> $GITHUB_STEP_SUMMARY
          echo "python manage.py migrate <app_name> <previous_migration>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restore database from snapshot" >> $GITHUB_STEP_SUMMARY
          echo "pg_restore -h <host> -U <user> -d <database> <backup_file>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Revert feature flags" >> $GITHUB_STEP_SUMMARY
          echo "curl -X POST https://api.launchdarkly.com/api/v2/flags/<project>/<flag>/environments/<env>/off" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Monitoring Links" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | URL | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | [Production Dashboard](https://grafana.example.com/d/production) | Metrics visualization |" >> $GITHUB_STEP_SUMMARY
          echo "| Prometheus | [Metrics](https://prometheus.example.com) | Time-series data |" >> $GITHUB_STEP_SUMMARY
          echo "| Jaeger | [Tracing](https://jaeger.example.com) | Distributed tracing |" >> $GITHUB_STEP_SUMMARY
          echo "| Sentry | [Error Tracking](https://sentry.example.com) | Exception monitoring |" >> $GITHUB_STEP_SUMMARY
          echo "| Datadog | [APM](https://app.datadoghq.com) | Application performance |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare | [Workers Analytics](https://dash.cloudflare.com) | Edge worker metrics |" >> $GITHUB_STEP_SUMMARY
          echo "| PagerDuty | [Incidents](https://pagerduty.com) | On-call management |" >> $GITHUB_STEP_SUMMARY
          echo "| Kibana | [Logs](https://kibana.example.com) | Log analysis |" >> $GITHUB_STEP_SUMMARY
          echo "| New Relic | [APM](https://newrelic.com) | Full-stack observability |" >> $GITHUB_STEP_SUMMARY
          echo "| StatusPage | [Status](https://status.example.com) | Public status page |" >> $GITHUB_STEP_SUMMARY
          echo "| Uptime Robot | [Uptime](https://uptimerobot.com) | External monitoring |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Components" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Health Check | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Server | Deployed | \`/health\` | \`${GITHUB_SHA:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Workers | Deployed | Wrangler tail | \`${GITHUB_SHA:0:7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Database Migrations | Applied | Connection test | Latest |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Layer | Active | \`/health/cache\` | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| Message Queue | Active | \`/health/queue\` | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| Search Index | Active | \`/health/search\` | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| CDN | Active | Edge check | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| Load Balancer | Active | Health probe | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Metrics to Monitor" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Normal Range | Alert Threshold | Dashboard |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------------|-----------------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Error Rate | < 0.1% | > 1% | Grafana |" >> $GITHUB_STEP_SUMMARY
          echo "| P99 Latency | < 500ms | > 2s | Datadog |" >> $GITHUB_STEP_SUMMARY
          echo "| CPU Usage | < 60% | > 85% | Prometheus |" >> $GITHUB_STEP_SUMMARY
          echo "| Memory Usage | < 70% | > 90% | Prometheus |" >> $GITHUB_STEP_SUMMARY
          echo "| Request Rate | Baseline Â±20% | Â±50% | Grafana |" >> $GITHUB_STEP_SUMMARY
          echo "| DB Connections | < 80% pool | > 95% pool | Grafana |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Hit Rate | > 90% | < 70% | Redis Dashboard |" >> $GITHUB_STEP_SUMMARY
          echo "| Queue Depth | < 1000 | > 5000 | RabbitMQ |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker Success Rate | > 99% | < 95% | Cloudflare |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Post-Deployment Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify health endpoints responding" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check error rates in monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Validate key user flows" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Monitor resource utilization" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Confirm log aggregation working" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify database connections stable" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check cache hit rates" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Validate external service integrations" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify Cloudflare Workers responding" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check API rate limiting functioning" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Validate authentication flows" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Confirm feature flags applied correctly" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Test webhook endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify SSL/TLS certificates valid" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check DNS propagation complete" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scaling Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Scale deployment (if needed)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl scale deployment/app-name -n production --replicas=<count>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Horizontal Pod Autoscaler status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get hpa -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Describe HPA for detailed metrics" >> $GITHUB_STEP_SUMMARY
          echo "kubectl describe hpa -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check rollout status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout status deployment/app-name -n production --timeout=5m" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View deployment history" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout history deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View specific revision details" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout history deployment/app-name -n production --revision=<revision>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get pod logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -l app=app-name -n production --tail=100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get pod logs with timestamps" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -l app=app-name -n production --tail=100 --timestamps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Follow logs in real-time" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f -l app=app-name -n production --tail=50" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get logs from previous container instance (after crash)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -l app=app-name -n production --previous --tail=100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get logs from all containers in pod" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -l app=app-name -n production --all-containers=true --tail=50" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Describe deployment" >> $GITHUB_STEP_SUMMARY
          echo "kubectl describe deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get all pods with wide output" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n production -l app=app-name -o wide" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get pods with custom columns" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n production -l app=app-name -o custom-columns='NAME:.metadata.name,STATUS:.status.phase,RESTARTS:.status.containerStatuses[0].restartCount,AGE:.metadata.creationTimestamp'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get resource usage" >> $GITHUB_STEP_SUMMARY
          echo "kubectl top pods -n production -l app=app-name" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get node resource usage" >> $GITHUB_STEP_SUMMARY
          echo "kubectl top nodes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get events sorted by time" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get events -n production --sort-by='.lastTimestamp' | tail -20" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get warning events only" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get events -n production --field-selector type=Warning --sort-by='.lastTimestamp'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restart deployment (rolling)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout restart deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pause rollout (for investigation)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout pause deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Resume rollout" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout resume deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback to previous revision" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout undo deployment/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollback to specific revision" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout undo deployment/app-name -n production --to-revision=<revision>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Exec into a pod for debugging" >> $GITHUB_STEP_SUMMARY
          echo "kubectl exec -it \$(kubectl get pods -n production -l app=app-name -o jsonpath='{.items[0].metadata.name}') -n production -- /bin/sh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Port forward for local debugging" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n production svc/app-name 8080:80" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check service endpoints" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get endpoints -n production app-name" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Describe service" >> $GITHUB_STEP_SUMMARY
          echo "kubectl describe svc/app-name -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check ingress configuration" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get ingress -n production -o wide" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get configmaps" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get configmap -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get secrets (names only)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get secrets -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check PodDisruptionBudget" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pdb -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check NetworkPolicy" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get networkpolicy -n production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Debug DNS resolution from pod" >> $GITHUB_STEP_SUMMARY
          echo "kubectl exec -it \$(kubectl get pods -n production -l app=app-name -o jsonpath='{.items[0].metadata.name}') -n production -- nslookup kubernetes.default" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check pod resource requests/limits" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n production -l app=app-name -o jsonpath='{range .items[*]}{.metadata.name}{\"\\t\"}{.spec.containers[*].resources}{\"\\n\"}{end}'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

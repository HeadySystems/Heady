name: HCFP Production Clean Build
# Clean build from scratch on every change with intelligent error handling

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main, production]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.12'

jobs:
  # Phase 1: Pre-flight validation
  preflight:
    name: Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.validate.outputs.proceed }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate no api.headysystems.com in production configs
        id: validate
        run: |
          echo "Checking for api.headysystems.com references in production configs..."
          if grep -r "api.headysystems.com" configs/*.yaml | grep -v "local.headysystems.com" | grep -v "#"; then
            echo "âŒ Found api.headysystems.com references in production configs"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… No api.headysystems.com references found"
          echo "proceed=true" >> $GITHUB_OUTPUT
      
      - name: Check service-discovery.yaml exists
        run: |
          if [ ! -f configs/service-discovery.yaml ]; then
            echo "âŒ service-discovery.yaml missing"
            exit 1
          fi
          echo "âœ… service-discovery.yaml found"

  # Phase 2: Clean build - Node.js
  build-node:
    name: Clean Build - Node.js
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_proceed == 'true'
    
    steps:
      - uses: actions/checkout@v4
        with:
          clean: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Clean workspace
        run: |
          echo "ðŸ§¹ Cleaning workspace..."
          rm -rf node_modules build dist coverage .next
          
      - name: Install dependencies (clean)
        id: npm_install
        run: |
          npm ci --ignore-scripts
        continue-on-error: true
      
      - name: Classify npm install error
        if: steps.npm_install.outcome == 'failure'
        run: |
          echo "::error::npm ci failed - checking if recoverable"
          
          # Check for network/registry issues (RECOVERABLE)
          if grep -i "ENOTFOUND\|ETIMEDOUT\|ECONNRESET" npm-debug.log 2>/dev/null; then
            echo "error_type=RECOVERABLE_NETWORK" >> $GITHUB_ENV
            exit 0
          fi
          
          # Check for code/config issues (NON-RECOVERABLE)
          if grep -i "EBADPLATFORM\|ENOENT\|syntax error" npm-debug.log 2>/dev/null; then
            echo "error_type=NON_RECOVERABLE_CODE" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "error_type=UNKNOWN" >> $GITHUB_ENV
          exit 1
      
      - name: Retry npm install (if recoverable)
        if: env.error_type == 'RECOVERABLE_NETWORK'
        run: |
          echo "ðŸ”„ Retrying npm ci (network issue)..."
          sleep 5
          npm ci --ignore-scripts
      
      - name: Run tests
        run: |
          npm test || echo "No tests configured"
      
      - name: Build artifacts
        run: |
          npm run build --if-present
      
      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: node-build
          path: |
            dist/
            build/
          retention-days: 7

  # Phase 3: Clean build - Python
  build-python:
    name: Clean Build - Python
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_proceed == 'true'
    
    steps:
      - uses: actions/checkout@v4
        with:
          clean: true
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Clean workspace
        run: |
          echo "ðŸ§¹ Cleaning Python workspace..."
          rm -rf __pycache__ .pytest_cache htmlcov .coverage
          find . -type d -name "*.egg-info" -exec rm -rf {} + || true
      
      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install --no-cache-dir -r requirements.txt
          fi
      
      - name: Run Python tests
        run: |
          if [ -f pytest.ini ]; then
            pytest --cov=src --cov-report=html || echo "Tests failed or not configured"
          fi

  # Phase 4: Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-node, build-python]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || echo "Vulnerabilities found - review required"
      
      - name: Check for secrets
        run: |
          echo "ðŸ” Scanning for exposed secrets..."
          if grep -r "sk_live_\|sk_test_\|ghp_\|gho_" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "::error::Potential secrets found in code"
            exit 1
          fi
          echo "âœ… No secrets detected"

  # Phase 5: Integration tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-node, build-python]
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: npm ci --ignore-scripts
      
      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@api.headysystems.com:5432/test
          REDIS_URL: redis://api.headysystems.com:6379
        run: |
          npm run test:integration || echo "Integration tests not configured"

  # Phase 6: Build status
  build-complete:
    name: Build Complete
    runs-on: ubuntu-latest
    needs: [build-node, build-python, security, integration]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "ðŸ“Š Build Status Summary:"
          echo "Node build: ${{ needs.build-node.result }}"
          echo "Python build: ${{ needs.build-python.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Integration: ${{ needs.integration.result }}"
          
          if [ "${{ needs.build-node.result }}" != "success" ] || \
             [ "${{ needs.build-python.result }}" != "success" ]; then
            echo "::error::Build failed - check logs above"
            exit 1
          fi
          
          echo "âœ… All builds successful"
      
      - name: Create release tag
        if: github.ref == 'refs/heads/main' && success()
        run: |
          echo "ðŸ·ï¸ Tagging successful build: build-$(date +%Y%m%d-%H%M%S)"
          BUILD_TAG="build-$(date +%Y%m%d-%H%M%S)"
          echo "BUILD_TAG=$BUILD_TAG" >> $GITHUB_ENV
          echo "ðŸ·ï¸ Tagging successful build: $BUILD_TAG"
          
          # Create git tag for successful builds
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$BUILD_TAG" -m "Automated build tag from CI" || echo "Tag creation skipped"

  # Phase 7: Artifact cleanup and retention
  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    needs: [build-complete]
    if: always()
    
    steps:
      - name: Remove temporary files
        run: |
          echo "ðŸ§¹ Cleaning up temporary build files..."
          rm -rf /tmp/heady-* || true
          
      - name: Prune old workflow runs
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ—‘ï¸ Cleanup complete - artifacts will expire per retention policy"

  # Phase 8: Code Quality Analysis
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: [preflight]
    if: needs.preflight.outputs.should_proceed == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: npm ci --ignore-scripts
        continue-on-error: true
      
      - name: Run ESLint
        run: |
          if [ -f .eslintrc.js ] || [ -f .eslintrc.json ] || [ -f eslint.config.js ]; then
            npx eslint . --format=compact --max-warnings=50 || echo "::warning::ESLint found issues"
          else
            echo "â­ï¸ ESLint not configured"
          fi
        continue-on-error: true
      
      - name: Run TypeScript check
        run: |
          if [ -f tsconfig.json ]; then
            npx tsc --noEmit || echo "::warning::TypeScript found type errors"
          else
            echo "â­ï¸ TypeScript not configured"
          fi
        continue-on-error: true
      
      - name: Check for console.log statements
        run: |
          echo "ðŸ” Checking for debug statements..."
          if grep -rn "console\.log\|console\.debug" src/ --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" 2>/dev/null | grep -v "// allowed" | head -20; then
            echo "::warning::Found console.log statements - consider removing for production"
          else
            echo "âœ… No problematic console statements found"
          fi
        continue-on-error: true

  # Phase 9: Deployment readiness check
  deploy-ready:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [build-complete, security, code-quality]
    if: github.ref == 'refs/heads/main' && needs.build-complete.result == 'success'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python for YAML validation
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install validation dependencies
        run: pip install pyyaml jsonschema
      
      - name: Validate deployment configs
        run: |
          echo "ðŸ” Validating deployment configuration..."
          
          # Check render.yaml exists and is valid
          if [ -f render.yaml ]; then
            echo "âœ… render.yaml found"
            # Validate YAML syntax
            python3 -c "import yaml; yaml.safe_load(open('render.yaml'))" || {
              echo "::error::render.yaml has syntax issues"
              exit 1
            }
            echo "âœ… render.yaml syntax valid"
          else
            echo "âš ï¸ render.yaml not found - deployment may fail"
          fi
          
          # Check service-discovery.yaml exists
          if [ -f configs/service-discovery.yaml ]; then
            echo "âœ… service-discovery.yaml found"
            # Validate YAML syntax
            python3 -c "import yaml; yaml.safe_load(open('configs/service-discovery.yaml'))" || {
              echo "::error::service-discovery.yaml has syntax issues"
              exit 1
            }
            echo "âœ… service-discovery.yaml syntax valid"
          else
            echo "::error::service-discovery.yaml missing - required for production"
            exit 1
          fi
          
          # Validate all YAML files in configs directory
          echo "ðŸ” Validating all config YAML files..."
          for file in configs/*.yaml configs/*.yml 2>/dev/null; do
            if [ -f "$file" ]; then
              python3 -c "import yaml; yaml.safe_load(open('$file'))" || {
                echo "::error::$file has syntax issues"
                exit 1
              }
              echo "âœ… $file syntax valid"
            fi
          done
          
          # Validate no localhost in production configs
          if grep -rE "localhost|127\.0\.0\.1|0\.0\.0\.0" render.yaml docker-compose*.yml configs/*.yaml 2>/dev/null | grep -v "#" | grep -v "test" | grep -v "local" | grep -v "development"; then
            echo "::warning::Found localhost references in deployment configs"
          fi
          
          # Validate no api.headysystems.com hardcoded (should use service discovery)
          if grep -rE "api\.headysystems\.com" render.yaml docker-compose*.yml 2>/dev/null | grep -v "#"; then
            echo "::error::Found hardcoded api.headysystems.com - use service-discovery.yaml instead"
            exit 1
          fi
          
          # Validate environment variables are properly templated
          echo "ðŸ” Checking for hardcoded secrets..."
          if grep -rE "(password|secret|api_key|token).*=.*['\"][^$]" configs/*.yaml 2>/dev/null | grep -v "#" | grep -v "example" | grep -v "placeholder"; then
            echo "::warning::Potential hardcoded secrets found in configs"
          fi
          
          # Check for required environment variables
          echo "ðŸ” Checking required environment variables in render.yaml..."
          if [ -f render.yaml ]; then
            REQUIRED_VARS=("DATABASE_URL" "NODE_ENV")
            for var in "${REQUIRED_VARS[@]}"; do
              if ! grep -q "$var" render.yaml; then
                echo "::warning::Required environment variable $var not found in render.yaml"
              fi
            done
          fi
          
          echo "âœ… Deployment configuration validation complete"
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: node-build
          path: dist/
        continue-on-error: true
      
      - name: Verify artifact integrity
        run: |
          echo "ðŸ” Verifying build artifact integrity..."
          if [ -d "dist" ] && [ "$(ls -A dist 2>/dev/null)" ]; then
            echo "âœ… Build artifacts present"
            ARTIFACT_SIZE=$(du -sb dist | cut -f1)
            echo "ðŸ“¦ Artifact size: $(du -sh dist | cut -f1)"
            
            # Sanity check - artifacts should be at least 1KB
            if [ "$ARTIFACT_SIZE" -lt 1024 ]; then
              echo "::error::Build artifacts too small - possible build failure"
              exit 1
            fi
            
            # Count files in dist
            FILE_COUNT=$(find dist -type f | wc -l)
            echo "ðŸ“ Total files: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -eq 0 ]; then
              echo "::error::No files found in build artifacts"
              exit 1
            fi
            
            # Check for source maps in production (security concern)
            if find dist -name "*.map" | head -1 | grep -q .; then
              echo "::warning::Source maps found in build artifacts - consider removing for production"
            fi
          else
            echo "::warning::Build artifacts missing or empty - may be expected if no build output"
          fi
      
      - name: Generate deployment manifest
        run: |
          echo "ðŸ“‹ Generating deployment manifest..."
          mkdir -p deploy
          
          # Generate manifest with proper JSON formatting
          cat > deploy/deployment-manifest.json << EOF
          {
            "build_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "commit": "${{ github.sha }}",
            "commit_short": "${GITHUB_SHA:0:7}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${{ github.actor }}",
            "repository": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "node_version": "${{ env.NODE_VERSION }}",
            "python_version": "${{ env.PYTHON_VERSION }}",
            "status": "ready",
            "checks": {
              "build": "${{ needs.build-complete.result }}",
              "security": "${{ needs.security.result }}",
              "code_quality": "${{ needs.code-quality.result }}"
            }
          }
          EOF
          
          echo "ðŸ“‹ Generated manifest:"
          cat deploy/deployment-manifest.json
          
          # Validate JSON syntax
          python3 -c "import json; json.load(open('deploy/deployment-manifest.json'))" || {
            echo "::error::Generated manifest has invalid JSON syntax"
            exit 1
          }
          echo "âœ… Manifest JSON syntax valid"
          
      - name: Upload deployment manifest
        uses: actions/upload-artifact@v4
        with:
          name: deployment-manifest
          path: deploy/deployment-manifest.json
          retention-days: 30

  # Phase 10: Dependency Analysis
  dependency-analysis:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    needs: [preflight]
    if: needs.preflight.outputs.should_proceed == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Check for outdated packages
        run: |
          echo "ðŸ“¦ Checking for outdated packages..."
          npm outdated --json > outdated.json 2>/dev/null || true
          
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
            echo "::warning::Some packages are outdated"
            cat outdated.json | head -50
          else
            echo "âœ… All packages are up to date"
          fi
        continue-on-error: true
      
      - name: Check for duplicate dependencies
        run: |
          echo "ðŸ” Checking for duplicate dependencies..."
          npm dedupe --dry-run 2>&1 | head -20 || echo "âœ… No duplicates found"
        continue-on-error: true
      
      - name: Analyze bundle size
        run: |
          if [ -f package.json ]; then
            echo "ðŸ“Š Package dependencies count:"
            DEPS=$(jq '.dependencies | length // 0' package.json)
            DEV_DEPS=$(jq '.devDependencies | length // 0' package.json)
            echo "  Production dependencies: $DEPS"
            echo "  Development dependencies: $DEV_DEPS"
            
            if [ "$DEPS" -gt 100 ]; then
              echo "::warning::High number of production dependencies ($DEPS) - consider auditing"
            fi
          fi
        continue-on-error: true

  # Phase 11: Notifications
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [build-complete, security, integration, code-quality, dependency-analysis]
    if: always()
    
    steps:
      - name: Determine overall status
        id: status
        run: |
          BUILD_RESULT="${{ needs.build-complete.result }}"
          SECURITY_RESULT="${{ needs.security.result }}"
          INTEGRATION_RESULT="${{ needs.integration.result }}"
          CODE_QUALITY_RESULT="${{ needs.code-quality.result }}"
          
          if [ "$BUILD_RESULT" == "success" ] && \
             [ "$SECURITY_RESULT" == "success" ] && \
             [ "$INTEGRATION_RESULT" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=All checks passed" >> $GITHUB_OUTPUT
          elif [ "$BUILD_RESULT" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Build failed" >> $GITHUB_OUTPUT
          elif [ "$SECURITY_RESULT" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ”’" >> $GITHUB_OUTPUT
            echo "message=Security scan failed" >> $GITHUB_OUTPUT
          elif [ "$INTEGRATION_RESULT" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ§ª" >> $GITHUB_OUTPUT
            echo "message=Integration tests failed" >> $GITHUB_OUTPUT
          elif [ "$CODE_QUALITY_RESULT" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ“" >> $GITHUB_OUTPUT
            echo "message=Code quality checks failed" >> $GITHUB_OUTPUT
          elif [ "$BUILD_RESULT" == "skipped" ] || [ "$SECURITY_RESULT" == "skipped" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "emoji=â­ï¸" >> $GITHUB_OUTPUT
            echo "message=Some checks were skipped" >> $GITHUB_OUTPUT
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
            echo "message=Some checks had issues" >> $GITHUB_OUTPUT
          fi
      
      - name: Post build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_END'
          ## ${{ steps.status.outputs.emoji }} HCFP Production Build Summary
          
          **Status:** ${{ steps.status.outputs.message }}
          
          ### Build Results
          
          | Component | Status |
          |-----------|--------|
          | Node.js Build | ${{ needs.build-complete.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-complete.result }} |
          | Security Scan | ${{ needs.security.result == 'success' && 'âœ…' || (needs.security.result == 'skipped' && 'â­ï¸' || 'âš ï¸') }} ${{ needs.security.result }} |
          | Integration Tests | ${{ needs.integration.result == 'success' && 'âœ…' || (needs.integration.result == 'skipped' && 'â­ï¸' || 'âš ï¸') }} ${{ needs.integration.result }} |
          | Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ…' || (needs.code-quality.result == 'skipped' && 'â­ï¸' || 'âš ï¸') }} ${{ needs.code-quality.result }} |
          | Dependency Analysis | ${{ needs.dependency-analysis.result ==





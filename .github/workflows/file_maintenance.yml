# HEADY_BRAND:BEGIN
# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó                     ‚ïë
# ‚ïë  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù                     ‚ïë
# ‚ïë  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù                      ‚ïë
# ‚ïë  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïî‚ïù                       ‚ïë
# ‚ïë  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë                        ‚ïë
# ‚ïë  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù                        ‚ïë
# ‚ïë                                                                  ‚ïë
# ‚ïë  ‚àû SACRED GEOMETRY ‚àû  Organic Systems ¬∑ Breathing Interfaces    ‚ïë
# ‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
# ‚ïë  FILE: .github/workflows/file_maintenance.yml                                                    ‚ïë
# ‚ïë  LAYER: root                                                  ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
# HEADY_BRAND:END
name: Weekly File Scan

on:
  schedule:
    - cron: '0 2 * * 1' # Every Monday 2 AM
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run pre-scan check
        run: |
          pwsh ./scripts/file_maintenance/pre_scan_check.ps1
        
      - name: Run automated scans (Layers 1-4)
        run: |
          pwsh ./scripts/file_maintenance/run_automated_scans.ps1
        
      - name: Create issues from scan results
        run: |
          echo "Issues would be created here based on scan output"
        # This would be implemented later
        
      - name: Commit and push updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "[FMSAP] Weekly scan updates" || echo "No changes to commit"
          git push
env:
  NODE_VERSION: '20.18.1'
  PYTHON_VERSION: '3.12.7'
  SCAN_TIMEOUT: 45
  ERROR_RETRY_COUNT: 3
  ERROR_RETRY_DELAY: 15
  HEADY_ENV: 'maintenance'
  CI_CLEAN_BUILD: 'true'
  HEADY_DOMAIN_ROOT: 'headysystems.com'

permissions:
  contents: write
  pull-requests: write
  issues: write
  security-events: write
  actions: read

concurrency:
  group: file-maintenance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preflight:
    name: 'üîç Preflight Checks'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_scan: ${{ steps.check.outputs.should_scan }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check scan prerequisites
        id: check
        run: |
          echo "üîç Running preflight checks..."
          
          # Check if scripts exist
          if [ -d "scripts/file_maintenance" ]; then
            echo "‚úÖ File maintenance scripts found"
            echo "should_scan=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è File maintenance scripts not found"
            echo "should_scan=false" >> $GITHUB_OUTPUT
          fi

  scan:
    name: 'üìÇ File Maintenance Scan'
    needs: preflight
    if: needs.preflight.outputs.should_scan == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: ${{ env.SCAN_TIMEOUT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Run pre-scan check
        id: prescan
        run: |
          if [ -f "./scripts/file_maintenance/pre_scan_check.ps1" ]; then
            pwsh ./scripts/file_maintenance/pre_scan_check.ps1
          else
            echo "‚è≠Ô∏è Pre-scan check script not found, skipping"
          fi
        continue-on-error: true

      - name: Run automated scans (Layers 1-4)
        id: scan
        run: |
          if [ -f "./scripts/file_maintenance/run_automated_scans.ps1" ]; then
            pwsh ./scripts/file_maintenance/run_automated_scans.ps1 2>&1 | tee scan.log
          else
            echo "‚è≠Ô∏è Automated scan script not found"
          fi
        continue-on-error: true

      - name: Classify scan errors
        if: steps.scan.outcome == 'failure'
        run: |
          SCAN_LOG="scan.log"
          
          if grep -q "ENOTFOUND\|ETIMEDOUT\|ECONNRESET" "$SCAN_LOG" 2>/dev/null; then
            echo "error_type=recoverable" >> $GITHUB_ENV
            echo "error_reason=network-issue" >> $GITHUB_ENV
          elif grep -q "timeout\|intermittent" "$SCAN_LOG" 2>/dev/null; then
            echo "error_type=recoverable" >> $GITHUB_ENV
            echo "error_reason=timeout" >> $GITHUB_ENV
          else
            echo "error_type=non-recoverable" >> $GITHUB_ENV
            echo "error_reason=scan-failure" >> $GITHUB_ENV
          fi

      - name: Retry on recoverable errors
        if: env.error_type == 'recoverable'
        run: |
          echo "üîÑ Retrying scan after recoverable error (${{ env.error_reason }})..."
          sleep ${{ env.ERROR_RETRY_DELAY }}
          
          for i in $(seq 1 ${{ env.ERROR_RETRY_COUNT }}); do
            echo "Retry attempt $i/${{ env.ERROR_RETRY_COUNT }}..."
            pwsh ./scripts/file_maintenance/run_automated_scans.ps1 && break
            if [ $i -eq ${{ env.ERROR_RETRY_COUNT }} ]; then
              echo "‚ùå All retry attempts exhausted"
              exit 1
            fi
            sleep ${{ env.ERROR_RETRY_DELAY }}
          done

      - name: Check for hardcoded localhost references
        run: |
          echo "üîç Scanning for hardcoded localhost references..."
          if grep -rn "localhost:3300\|127.0.0.1:3300" --include="*.js" --include="*.ts" --include="*.py" --include="*.yaml" src/ 2>/dev/null | head -10; then
            echo "::warning::Found hardcoded localhost references"
          else
            echo "‚úÖ No problematic localhost references found"
          fi
        continue-on-error: true

      - name: Create issues from scan results
        run: |
          echo "üìã Processing scan results..."
          if [ -f "scan.log" ]; then
            echo "Scan completed - issues would be created based on output"
          fi

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scan-results-${{ github.run_number }}
          path: |
            scan.log
            **/scan-report*.json
          retention-days: 7

      - name: Commit and push updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "[FMSAP] Weekly scan updates - Run #${{ github.run_number }}"
          git push
        continue-on-error: true

  notify-failure:
    name: 'üö® Notify on Failure'
    needs: [scan]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® File Maintenance Scan Failed - Run #${{ github.run_number }}`;
            const body = `
            ## Scan Failure Report
            
            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            **Actor:** ${{ github.actor }}
            
            Please investigate the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'automated', 'needs-attention']
            });
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        continue-on-error: true

  cleanup:
    name: 'üßπ Cleanup'
    needs: [scan]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Remove temporary files
        run: |
          echo "üßπ Cleaning up temporary build files..."
          rm -rf /tmp/heady-* 2>/dev/null || true
          rm -rf /tmp/scan-* 2>/dev/null || true
          rm -rf /tmp/npm-* 2>/dev/null || true
          rm -rf ~/.npm/_cacache 2>/dev/null || true
          echo "‚úÖ Temporary files cleaned"
          
      - name: Prune old workflow artifacts
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const daysToKeep = 7;
            const cutoffDate = new Date(Date.now() - daysToKeep * 24 * 60 * 60 * 1000);
            
            console.log(`üóëÔ∏è Pruning artifacts older than ${daysToKeep} days...`);
            
            const artifacts = await github.paginate(
              github.rest.actions.listArtifactsForRepo,
              { owner, repo, per_page: 100 }
            );
            
            let deletedCount = 0;
            for (const artifact of artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < cutoffDate) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner,
                    repo,
                    artifact_id: artifact.id
                  });
                  deletedCount++;
                } catch (e) {
                  console.log(`Failed to delete artifact ${artifact.id}: ${e.message}`);
                }
              }
            }
            
            console.log(`‚úÖ Deleted ${deletedCount} old artifacts`);
            core.setOutput('deleted_count', deletedCount);

      - name: Clean stale branches
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const { owner, repo } = context.repo;
            const staleDays = 30;
            const cutoffDate = new Date(Date.now() - staleDays * 24 * 60 * 60 * 1000);
            
            console.log(`üîç Checking for stale branches older than ${staleDays} days...`);
            
            const branches = await github.paginate(
              github.rest.repos.listBranches,
              { owner, repo, per_page: 100 }
            );
            
            const protectedBranches = ['main', 'master', 'develop', 'staging', 'production'];
            let staleCount = 0;
            
            for (const branch of branches) {
              if (protectedBranches.includes(branch.name)) continue;
              
              try {
                const { data: commit } = await github.rest.repos.getCommit({
                  owner,
                  repo,
                  ref: branch.commit.sha
                });
                
                const commitDate = new Date(commit.commit.committer.date);
                if (commitDate < cutoffDate) {
                  console.log(`‚ö†Ô∏è Stale branch found: ${branch.name} (last commit: ${commitDate.toISOString()})`);
                  staleCount++;
                }
              } catch (e) {
                console.log(`Error checking branch ${branch.name}: ${e.message}`);
              }
            }
            
            console.log(`üìä Found ${staleCount} stale branches`);
            core.setOutput('stale_branches', staleCount);

  summary:
    name: 'üìä Generate Summary'
    needs: [scan, cleanup]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Generate workflow summary
        env:
          SCAN_RESULT: ${{ needs.scan.result }}
          CLEANUP_RESULT: ${{ needs.cleanup.result }}
        run: |
          echo "## üìä File Maintenance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status badge
          if [ "$SCAN_RESULT" = "success" ] && [ "$CLEANUP_RESULT" = "success" ]; then
            echo "![Status](https://img.shields.io/badge/Maintenance-Success-brightgreen)" >> $GITHUB_STEP_SUMMARY
          elif [ "$SCAN_RESULT" = "failure" ] || [ "$CLEANUP_RESULT" = "failure" ]; then
            echo "![Status](https://img.shields.io/badge/Maintenance-Failed-red)" >> $GITHUB_STEP_SUMMARY
          else
            echo "![Status](https://img.shields.io/badge/Maintenance-Partial-yellow)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üìã Run Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Full SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Attempt | ${{ github.run_attempt }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üìà Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | ${{ needs.scan.result == 'success' && '‚úÖ Success' || needs.scan.result == 'failure' && '‚ùå Failed' || needs.scan.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ö†Ô∏è ' }}${{ needs.scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cleanup | ${{ needs.cleanup.result == 'success' && '‚úÖ Success' || needs.cleanup.result == 'failure' && '‚ùå Failed' || needs.cleanup.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ö†Ô∏è ' }}${{ needs.cleanup.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üîß Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Re-run maintenance workflow" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run file_maintenance.yml --ref ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View workflow logs" >> $GITHUB_STEP_SUMMARY
          echo "gh run view ${{ github.run_id }} --log" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üìö Resources" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Link |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/.github/workflows/file_maintenance.yml) | View source |" >> $GITHUB_STEP_SUMMARY
          echo "| [All Runs](${{ github.server_url }}/${{ github.repository }}/actions/workflows/file_maintenance.yml) | History |" >> $GITHUB_STEP_SUMMARY
          echo "| [Repository Settings](${{ github.server_url }}/${{ github.repository }}/settings) | Configure |" >> $GITHUB_STEP_SUMMARY

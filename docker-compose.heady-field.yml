# HEADY_BRAND:BEGIN
# ╔══════════════════════════════════════════════════════════════════╗
# ║  ██╗  ██╗███████╗ █████╗ ██████╗ ██╗   ██╗                     ║
# ║  ██║  ██║██╔════╝██╔══██╗██╔══██╗╚██╗ ██╔╝                     ║
# ║  ███████║█████╗  ███████║██║  ██║ ╚████╔╝                      ║
# ║  ██╔══██║██╔══╝  ██╔══██║██║  ██║  ╚██╔╝                       ║
# ║  ██║  ██║███████╗██║  ██║██████╔╝   ██║                        ║
# ║  ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═════╝    ╚═╝                        ║
# ║                                                                  ║
# ║  ∞ SACRED GEOMETRY ∞  Organic Systems · Breathing Interfaces    ║
# ║  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  ║
# ║  FILE: docker-compose.heady-field.yml                           ║
# ║  LAYER: infrastructure                                          ║
# ║  PURPOSE: HeadyField Regenerative Oracle Data Node               ║
# ╚══════════════════════════════════════════════════════════════════╝
# HEADY_BRAND:END

version: '3.8'

services:
  # 1. The Listener (MQTT Broker) - Receives raw data from ESP32 soil sensors
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: heady_mqtt
    ports:
      - "1883:1883"  # Standard MQTT port
      - "9001:9001"  # Websocket port for web clients
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    environment:
      - MOSQUITTO_USERNAME=heady_field
      - MOSQUITTO_PASSWORD=${MOSQUITTO_PASSWORD}
    restart: unless-stopped
    networks:
      - heady_field_net
    healthcheck:
      test: ["CMD", "mosquitto_pub", "-h", "localhost", "-t", "test", "-m", "health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 2. The Vault (Time-Series Database) - Stores ecological data efficiently
  influxdb:
    image: influxdb:2.7
    container_name: heady_vault
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=heady_admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=HeadyConnection
      - DOCKER_INFLUXDB_INIT_BUCKET=field_data
      - DOCKER_INFLUXDB_INIT_RETENTION=365d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
    restart: unless-stopped
    networks:
      - heady_field_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 3. The Oracle (Custom Python Service) - Verifies and processes sensor data
  heady_oracle:
    build:
      context: ./oracle_service
      dockerfile: Dockerfile
    container_name: heady_oracle
    depends_on:
      mosquitto:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    environment:
      - MQTT_BROKER=heady_mqtt
      - MQTT_PORT=1883
      - MQTT_USERNAME=heady_field
      - MQTT_PASSWORD=${MOSQUITTO_PASSWORD}
      - INFLUX_URL=http://heady_vault:8086
      - INFLUX_TOKEN=${INFLUXDB_TOKEN}
      - INFLUX_ORG=HeadyConnection
      - INFLUX_BUCKET=field_data
      - ORACLE_PRIVATE_KEY=${ORACLE_PRIVATE_KEY}
      - HEADY_BRAIN_ENDPOINT=https://headyio.com/api/brain/analyze
      - FIBONACCI_BACKOFF=true
      - VERIFICATION_THRESHOLD=0.95
    volumes:
      - ./oracle_service/logs:/app/logs
      - ./oracle_service/config:/app/config
    restart: unless-stopped
    networks:
      - heady_field_net
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health')"]
      interval: 60s
      timeout: 10s
      retries: 3

  # 4. The Dashboard (Visualization) - Public face for donors/users
  grafana:
    image: grafana/grafana:10.2.0
    container_name: heady_viz
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_SECURITY_ADMIN_USER=heady_admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
      - GF_SERVER_DOMAIN=headyio.com
      - GF_SERVER_ROOT_URL=https://headyio.com/grafana
    depends_on:
      influxdb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - heady_field_net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 5. The Guardian (AI Auditor) - Validates data before blockchain commitment
  heady_auditor:
    build:
      context: ./auditor_service
      dockerfile: Dockerfile
    container_name: heady_auditor
    depends_on:
      influxdb:
        condition: service_healthy
    environment:
      - INFLUX_URL=http://heady_vault:8086
      - INFLUX_TOKEN=${INFLUXDB_TOKEN}
      - INFLUX_ORG=HeadyConnection
      - INFLUX_BUCKET=field_data
      - AI_MODEL_PATH=/app/models/auditor.pt
      - ANOMALY_THRESHOLD=2.5
      - BLOCKCHAIN_ENDPOINT=${BLOCKCHAIN_RPC_URL}
    volumes:
      - ./auditor_service/models:/app/models
      - ./auditor_service/logs:/app/logs
    restart: unless-stopped
    networks:
      - heady_field_net
    profiles:
      - blockchain  # Only start if blockchain integration enabled

  # 6. The Bridge (MIDI Control) - Physical administration via music gear
  heady_midi_bridge:
    build:
      context: ./midi_bridge
      dockerfile: Dockerfile
    container_name: heady_midi_bridge
    environment:
      - MIDI_DEVICE=/dev/snd/midiC1D0
      - DOCKER_SOCKET=/var/run/docker.sock
      - HEADY_ORACLE_URL=http://heady_oracle:8080
      - GRAFANA_URL=http://heady_viz:3000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /dev/snd:/dev/snd
      - ./midi_bridge/config:/app/config
    restart: unless-stopped
    networks:
      - heady_field_net
    profiles:
      - midi_control  # Only start with MIDI profile

volumes:
  influxdb_data:
    driver: local
  influxdb_config:
    driver: local
  grafana_data:
    driver: local

networks:
  heady_field_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

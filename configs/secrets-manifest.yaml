# HEADY_BRAND:BEGIN
# ╔══════════════════════════════════════════════════════════════════╗
# ║  ██╗  ██╗███████╗ █████╗ ██████╗ ██╗   ██╗                     ║
# ║  ██║  ██║██╔════╝██╔══██╗██╔══██╗╚██╗ ██╔╝                     ║
# ║  ███████║█████╗  ███████║██║  ██║ ╚████╔╝                      ║
# ║  ██╔══██║██╔══╝  ██╔══██║██║  ██║  ╚██╔╝                       ║
# ║  ██║  ██║███████╗██║  ██║██████╔╝   ██║                        ║
# ║  ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═════╝    ╚═╝                        ║
# ║                                                                  ║
# ║  ∞ SACRED GEOMETRY ∞  Organic Systems · Breathing Interfaces    ║
# ║  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  ║
# ║  FILE: configs/secrets-manifest.yaml                                                    ║
# ║  LAYER: config                                                  ║
# ╚══════════════════════════════════════════════════════════════════╝
# HEADY_BRAND:END
# ═══════════════════════════════════════════════════════════════════════
# HEADY SYSTEMS — Secrets Manifest
# ═══════════════════════════════════════════════════════════════════════
# Declares every secret/token in the ecosystem, its source, expiry
# policy, and what depends on it. The SecretsManager uses this at boot
# to register and monitor all credentials.

version: "1.0.0"

secrets:
  # ─── Cloudflare (auto-refreshable) ────────────────────────────────
  - id: cloudflare_oauth
    name: Cloudflare OAuth Token
    source: file
    envVar: null
    filePath: wrangler_config  # resolved at runtime
    expiryPolicy: 1h  # Cloudflare OAuth tokens last ~1 hour
    refreshable: true
    refreshMethod: oauth_refresh
    dependents: [cloudflare-worker, dns-management, domain-routing]
    tags: [cloudflare, oauth, auto-refresh, infrastructure]

  - id: cloudflare_refresh_token
    name: Cloudflare Refresh Token
    source: file
    expiryPolicy: single_use  # replaced on each refresh
    refreshable: false
    tags: [cloudflare, oauth]

  # ─── Render (API key — no auto-expiry) ────────────────────────────
  - id: render_api_key
    name: Render API Key
    source: env
    envVar: RENDER_API_KEY
    expiryPolicy: manual  # user must rotate
    refreshable: false
    dependents: [render-deploy, service-management]
    tags: [render, api-key, infrastructure]

  # ─── Heady Internal ───────────────────────────────────────────────
  - id: heady_api_key
    name: Heady API Key
    source: env
    envVar: HEADY_API_KEY
    expiryPolicy: manual
    refreshable: false
    dependents: [api-gateway, mcp-server]
    tags: [heady, auth, internal]

  - id: admin_token
    name: Admin Token
    source: env
    envVar: ADMIN_TOKEN
    expiryPolicy: manual
    refreshable: false
    dependents: [admin-panel, system-production]
    tags: [heady, auth, admin]

  # ─── Database ─────────────────────────────────────────────────────
  - id: database_url
    name: PostgreSQL Connection String
    source: env
    envVar: DATABASE_URL
    expiryPolicy: never
    refreshable: false
    dependents: [database, persistence]
    tags: [database, postgres, infrastructure]

  # ─── Hugging Face ─────────────────────────────────────────────────
  - id: hf_token
    name: Hugging Face API Token
    source: env
    envVar: HF_TOKEN
    expiryPolicy: manual  # HF tokens don't auto-expire but can be revoked
    refreshable: false
    dependents: [pythia-node, ai-inference]
    tags: [huggingface, ai, api-key]

  # ─── Notion ───────────────────────────────────────────────────────
  - id: notion_token
    name: Notion Integration Token
    source: env
    envVar: NOTION_TOKEN
    expiryPolicy: manual
    refreshable: false
    dependents: [notion-sync, checkpoint-protocol]
    tags: [notion, integration]

  # ─── GitHub ───────────────────────────────────────────────────────
  - id: github_token
    name: GitHub Personal Access Token
    source: env
    envVar: GITHUB_TOKEN
    expiryPolicy: manual  # PATs have configurable expiry
    refreshable: false
    dependents: [heady-sync, ci-cd, copilot]
    tags: [github, auth, vcs]

  # ─── Stripe ───────────────────────────────────────────────────────
  - id: stripe_secret_key
    name: Stripe Secret Key
    source: env
    envVar: STRIPE_SECRET_KEY
    expiryPolicy: never  # Stripe keys don't expire but can be rolled
    refreshable: false
    dependents: [billing, pricing-tiers]
    tags: [stripe, payments, billing]

  - id: stripe_webhook_secret
    name: Stripe Webhook Secret
    source: env
    envVar: STRIPE_WEBHOOK_SECRET
    expiryPolicy: never
    refreshable: false
    dependents: [billing-webhooks]
    tags: [stripe, payments, webhook]

  # ─── New Additions ─────────────────────────────────────────────
  - id: headybrowser_api_key
    name: HeadyBrowser API Key
    source: env
    envVar: HEADYBROWSER_API_KEY
    expiryPolicy: manual
    dependents: [headybrowser-desktop, headybrowser-mobile]
    tags: [heady, browser, auth]

  - id: headybuddy_token
    name: HeadyBuddy Service Token
    source: env
    envVar: HEADYBUDDY_TOKEN
    expiryPolicy: 90d
    refreshable: true
    dependents: [headybuddy-desktop, headybuddy-mobile]
    tags: [heady, companion, auth]

  - id: redis_url
    name: Redis Connection URL
    source: env
    envVar: REDIS_URL
    expiryPolicy: never
    dependents: [caching, session-store]
    tags: [redis, infrastructure]

environments:
  production:
    secrets:
      - id: database_url
        source: vault
        vaultPath: secrets/data/prod/database
      - id: heady_api_key
        source: vault
        vaultPath: secrets/data/prod/core

  staging:
    secrets:
      - id: database_url
        source: vault
        vaultPath: secrets/data/staging/database
      - id: heady_api_key
        source: vault
        vaultPath: secrets/data/staging/core

devices:
  bindingPolicy: single_device
  allowedDevices:
    - type: laptop
      maxSecrets: 50
    - type: mobile
      maxSecrets: 20
    - type: server
      maxSecrets: unlimited

# ─── Policies ───────────────────────────────────────────────────────
policies:
  warnBeforeExpiryMinutes: 15
  checkIntervalSeconds: 60
  auditRetention: 500
  alertChannels:
    - console
    - api  # GET /api/secrets/alerts
  rotationReminders:
    render_api_key: 90d
    heady_api_key: 90d
    hf_token: 180d
    github_token: 90d
    notion_token: never

rotation:
  autoRotate:
    - id: heady_api_key
      interval: 90d
      notify: [email, console]
    - id: render_api_key
      interval: 90d
      notify: [email, console]
    - id: hf_token
      interval: 180d
      notify: [email]

  manualRotate:
    - id: database_url
      instructions: "Run `heady-secrets rotate database`"
    - id: redis_url
      instructions: "Run `heady-secrets rotate redis`"

alerts:
  expired:
    channels: [email, slack]
    template: "Secret {id} expired at {time}"
  soonToExpire:
    channels: [console]
    template: "Secret {id} expires in {remaining}"

# HEADY_BRAND:BEGIN
# ╔══════════════════════════════════════════════════════════════════╗
# ║  ██╗  ██╗███████╗ █████╗ ██████╗ ██╗   ██╗                     ║
# ║  ██║  ██║██╔════╝██╔══██╗██╔══██╗╚██╗ ██╔╝                     ║
# ║  ███████║█████╗  ███████║██║  ██║ ╚████╔╝                      ║
# ║  ██╔══██║██╔══╝  ██╔══██║██║  ██║  ╚██╔╝                       ║
# ║  ██║  ██║███████╗██║  ██║██████╔╝   ██║                        ║
# ║  ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═════╝    ╚═╝                        ║
# ║                                                                  ║
# ║  ∞ SACRED GEOMETRY ∞  Organic Systems · Breathing Interfaces    ║
# ║  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  ║
# ║  FILE: .github/workflows/api.headysystems.com-validation.yml                                                    ║
# ║  LAYER: root                                                  ║
# ╚══════════════════════════════════════════════════════════════════╝
# HEADY_BRAND:END
name: api.headysystems.com/Internal IP Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-no-api.headysystems.com:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y grep
        
    - name: Validate documentation
      run: |
        echo "Checking documentation for api.headysystems.com/internal IP references..."
        
        # Check for api.headysystems.com in documentation
        if grep -r --include="*.md" --include="*.rst" --include="*.txt" \
          -E "(api.headysystems.com|127\.0\.0\.1|10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.1[6-9]\.\d+\.\d+|172\.2[0-9]\.\d+\.\d+|172\.3[0-1]\.\d+\.\d+)" \
          docs/ README.md *.md; then
          echo "❌ ERROR: Found api.headysystems.com or internal IP references in documentation"
          echo "Please use proper Heady domains as per the URL style guide"
          exit 1
        fi
        
        echo "✅ Documentation validation passed"
        
    - name: Validate configuration files
      run: |
        echo "Checking configuration files for api.headysystems.com/internal IP references..."
        
        # Check production configs (exclude local dev configs)
        if grep -r --include="*.yaml" --include="*.yml" --include="*.json" --include="*.conf" \
          -E "(api.headysystems.com|127\.0\.0\.1|10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.1[6-9]\.\d+\.\d+|172\.2[0-9]\.\d+\.\d+|172\.3[0-1]\.\d+\.\d+)" \
          configs/ --exclude="*local*" --exclude="*dev*" --exclude="hosts-file"; then
          echo "❌ ERROR: Found api.headysystems.com or internal IP references in production configs"
          echo "Please use environment variables or proper domain references"
          exit 1
        fi
        
        echo "✅ Configuration validation passed"
        
    - name: Validate code examples
      run: |
        echo "Checking code files for api.headysystems.com URLs in comments and examples..."
        
        # Check for api.headysystems.com in Python files (excluding test files and local configs)
        if grep -r --include="*.py" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
          -E "(http://api.headysystems.com|http://127\.0\.0\.1)" \
          src/ --exclude-dir="test*" --exclude="*test*" --exclude="*local*"; then
          echo "❌ ERROR: Found api.headysystems.com URLs in code examples"
          echo "Please use proper Heady domains or environment variables"
          exit 1
        fi
        
        echo "✅ Code validation passed"
        
    - name: Validate API documentation
      run: |
        echo "Checking API documentation for proper domain usage..."
        
        # Ensure API docs use proper domains
        if ! grep -q "https://api.headysystems.com" docs/ 2>/dev/null; then
          echo "⚠️  WARNING: API documentation should include examples with https://api.headysystems.com"
        fi
        
        if ! grep -q "https://api.headyconnection.org" docs/ 2>/dev/null; then
          echo "⚠️  WARNING: API documentation should include examples with https://api.headyconnection.org"
        fi
        
        echo "✅ API documentation check completed"
        
    - name: Validate OAuth callback URLs
      run: |
        echo "Checking OAuth callback URLs for proper domains..."
        
        # Look for OAuth callback configurations
        if grep -r --include="*.yaml" --include="*.yml" --include="*.json" --include="*.py" --include="*.js" \
          -E "(api.headysystems.com|127\.0\.0\.1).*oauth.*callback" \
          .; then
          echo "❌ ERROR: Found api.headysystems.com in OAuth callback URLs"
          echo "Please use proper domains like https://app.headysystems.com/oauth/callback"
          exit 1
        fi
        
        echo "✅ OAuth callback validation passed"
        
    - name: Validate Docker and deployment files
      run: |
        echo "Checking Docker and deployment files..."
        
        # Check Docker files for api.headysystems.com exposure
        if grep -r --include="Dockerfile*" --include="docker-compose*" \
          -E "(api.headysystems.com|127\.0\.0\.1)" \
          . --exclude="*local*" --exclude="*dev*"; then
          echo "❌ ERROR: Found api.headysystems.com references in Docker/deployment files"
          echo "Please use service names or proper domains"
          exit 1
        fi
        
        echo "✅ Docker/deployment validation passed"
        
    - name: Check for hardcoded ports with api.headysystems.com
      run: |
        echo "Checking for hardcoded api.headysystems.com ports..."
        
        # Look for patterns like api.headysystems.com:3000, api.headysystems.com:8000
        if grep -r -E "(api.headysystems.com|127\.0\.0\.1):\d+" \
          --include="*.md" --include="*.py" --include="*.js" --include="*.yaml" --include="*.yml" \
          . --exclude-dir=".git" --exclude="*local*" --exclude="*dev*"; then
          echo "❌ ERROR: Found api.headysystems.com with hardcoded ports"
          echo "Please use proper domains or environment variables"
          exit 1
        fi
        
        echo "✅ Port validation passed"
        
    - name: Validate environment variable examples
      run: |
        echo "Checking environment variable examples..."
        
        # Ensure .env.example files use proper domains
        if find . -name "*.env.example" -exec grep -l "api.headysystems.com\|127\.0\.0\.1" {} \;; then
          echo "❌ ERROR: Found api.headysystems.com references in .env.example files"
          echo "Please use proper domains like:"
          echo "  API_BASE_URL=https://api.headysystems.com"
          echo "  WEB_APP_URL=https://app.headysystems.com"
          exit 1
        fi
        
        echo "✅ Environment variable validation passed"
        
    - name: Generate validation report
      if: always()
      run: |
        echo "## api.headysystems.com/Internal IP Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ All validations passed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Checked Files:" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation (*.md, *.rst, *.txt)" >> $GITHUB_STEP_SUMMARY
        echo "- Configuration files (*.yaml, *.yml, *.json, *.conf)" >> $GITHUB_STEP_SUMMARY
        echo "- Source code (*.py, *.js, *.ts, *.jsx, *.tsx)" >> $GITHUB_STEP_SUMMARY
        echo "- Docker files" >> $GITHUB_STEP_SUMMARY
        echo "- Environment examples (*.env.example)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Exclusions:" >> $GITHUB_STEP_SUMMARY
        echo "- Local development files (*local*, *dev*)" >> $GITHUB_STEP_SUMMARY
        echo "- Test files" >> $GITHUB_STEP_SUMMARY
        echo "- Hosts file mappings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This ensures no api.headysystems.com or internal IPs leak into production documentation or code." >> $GITHUB_STEP_SUMMARY

  validate-domain-consistency:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check domain consistency
      run: |
        echo "Checking domain consistency across files..."
        
        # Ensure consistent domain usage
        DOMAINS=("headysystems.com" "headyconnection.org" "headybuddy.org")
        
        for domain in "${DOMAINS[@]}"; do
          echo "Checking $domain usage..."
          
          # Look for inconsistent domain patterns
          if grep -r -i "www\.$domain" . --exclude-dir=".git" | grep -v "redirect.*www"; then
            echo "⚠️  WARNING: Found www.$domain usage (should redirect to $domain)"
          fi
          
          # Look for HTTP usage (should be HTTPS)
          if grep -r "http://$domain" . --exclude-dir=".git" --exclude="*local*"; then
            echo "⚠️  WARNING: Found http://$domain (should be https://$domain)"
          fi
        done
        
        echo "✅ Domain consistency check completed"
        
    - name: Validate SSL configuration
      run: |
        echo "Checking SSL configuration requirements..."
        
        # Ensure production configs require SSL
        if ! grep -r "ssl.*required" configs/domain-architecture.yaml; then
          echo "⚠️  WARNING: SSL requirements not clearly specified"
        fi
        
        # Check for proper SSL certificate paths in Nginx configs
        if find configs/nginx -name "*.conf" -exec grep -L "ssl_certificate" {} \; | grep -v "local-dev"; then
          echo "⚠️  WARNING: Some Nginx configs missing SSL certificate configuration"
        fi
        
        echo "✅ SSL configuration check completed"

          # Exclude test files and local development configs
          if grep -r "http://$domain" . \
            --exclude-dir=".git" \
            --exclude-dir="node_modules" \
            --exclude-dir=".next" \
            --exclude-dir="dist" \
            --exclude-dir="build" \
            --exclude-dir="coverage" \
            --exclude-dir="__pycache__" \
            --exclude-dir=".venv" \
            --exclude-dir="venv" \
            --exclude-dir=".cache" \
            --exclude="*local*" \
            --exclude="*test*" \
            --exclude="*spec*" \
            --exclude="*.log" \
            --exclude="*.lock" \
            2>/dev/null; then
            echo "⚠️  WARNING: Found http://$domain (should be https://$domain)"
          fi
        done
        
        # Check for mixed content issues
        echo "Checking for mixed content patterns..."
        if grep -r -E "https://[^\"']+.*http://[^\"']+" \
          --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" --include="*.html" --include="*.vue" --include="*.svelte" \
          . --exclude-dir=".git" --exclude-dir="node_modules" --exclude-dir="dist" --exclude-dir="build" 2>/dev/null; then
          echo "⚠️  WARNING: Potential mixed content detected"
        fi
        
        # Validate API endpoint consistency
        echo "Checking API endpoint consistency..."
        API_PATTERNS=("api.headysystems.com" "api.headyconnection.org")
        for api in "${API_PATTERNS[@]}"; do
          COUNT=$(grep -r "https://$api" . --exclude-dir=".git" --exclude-dir="node_modules" --exclude-dir="dist" 2>/dev/null | wc -l || echo "0")
          echo "  Found $COUNT references to https://$api"
        done
        
        # Check for localhost references that should be domains
        echo "Checking for localhost references in production code..."
        if grep -r -E "(localhost|127\.0\.0\.1|0\.0\.0\.0)" \
          --include="*.yaml" --include="*.yml" --include="*.json" \
          . --exclude-dir=".git" --exclude-dir="node_modules" \
          --exclude="*local*" --exclude="*dev*" --exclude="*development*" \
          --exclude="hosts-file*" --exclude="*localhost-validation*" 2>/dev/null | \
          grep -v "localhost-validation" | grep -v "hosts-file"; then
          echo "⚠️  WARNING: Found localhost references in production configs"
        fi
        
        # Validate CORS origin patterns
        echo "Checking CORS configuration..."
        if grep -r -E "Access-Control-Allow-Origin.*\*" \
          --include="*.js" --include="*.ts" --include="*.py" --include="*.yaml" \
          . --exclude-dir=".git" --exclude-dir="node_modules" --exclude="*test*" --exclude="*dev*" 2>/dev/null; then
          echo "⚠️  WARNING: Found wildcard CORS origins (security concern)"
        fi
        
        # Check for hardcoded credentials patterns
        echo "Checking for potential hardcoded credentials..."
        if grep -r -E "(password|secret|api_key|apikey|token)[[:space:]]*[=:][[:space:]]*['\"][^'\"]{8,}['\"]" \
          --include="*.js" --include="*.ts" --include="*.py" --include="*.yaml" --include="*.json" \
          . --exclude-dir=".git" --exclude-dir="node_modules" --exclude="*.example" --exclude="*test*" 2>/dev/null | \
          grep -vE "(process\.env|os\.environ|getenv|ENV\[|\.env)" 2>/dev/null; then
          echo "⚠️  WARNING: Potential hardcoded credentials detected"
        fi
        
        # Check for deprecated API patterns
        echo "Checking for deprecated API patterns..."
        if grep -r -E "(api/v0|/api/legacy|deprecated)" \
          --include="*.js" --include="*.ts" --include="*.py" \
          . --exclude-dir=".git" --exclude-dir="node_modules" --exclude="*test*" 2>/dev/null; then
          echo "⚠️  WARNING: Found deprecated API patterns"
        fi
        
        # Validate WebSocket URL consistency
        echo "Checking WebSocket URL patterns..."
        if grep -r -E "ws://[^l]" \
          --include="*.js" --include="*.ts" --include="*.yaml" \
          . --exclude-dir=".git" --exclude-dir="node_modules" --exclude="*local*" --exclude="*dev*" 2>/dev/null; then
          echo "⚠️  WARNING: Found non-secure WebSocket (ws://) in production code (should be wss://)"
        fi
        
        # Check for proper environment variable usage
        echo "Checking environment variable patterns..."
        if grep -r -E "process\.env\.[A-Z_]+[[:space:]]*\|\|[[:space:]]*['\"]https?://" \
          --include="*.js" --include="*.ts" \
          . --exclude-dir=".git" --exclude-dir="node_modules" 2>/dev/null | head -5; then
          echo "ℹ️  INFO: Environment variables with URL fallbacks detected (verify fallbacks are appropriate)"
        fi
        
        # Check for Heady-specific domain patterns
        echo "Checking Heady domain patterns..."
        HEADY_DOMAINS=("headysystems.com" "headyconnection.org" "headybuddy.org")
        for hd in "${HEADY_DOMAINS[@]}"; do
          if grep -r -E "[a-z]+\.$hd" . --exclude-dir=".git" --exclude-dir="node_modules" 2>/dev/null | \
            grep -vE "(api|app|www|mail|cdn|assets|static)\.$hd" | head -3; then
            echo "ℹ️  INFO: Found non-standard subdomain for $hd"
          fi
        done
        
        # Check for banned cloud provider domains per naming-compliance.yml
        echo "Checking for banned cloud provider domains..."
        if grep -r -E "\.onrender\.com|\.vercel\.app|\.netlify\.app|\.herokuapp\.com|\.firebaseapp\.com" \
          --include="*.js" --include="*.ts" --include="*.json" --include="*.yaml" \
          . --exclude-dir=".git" --exclude-dir="node_modules" 2>/dev/null; then
          echo "⚠️  WARNING: Found banned cloud provider domains (should use Heady domains)"
        fi
        
        # Check for Windows drive letter paths per naming-compliance.yml
        echo "Checking for Windows drive letter paths..."
        if grep -r -E "[A-Z]:\\\\" \
          --include="*.js" --include="*.ts" --include="*.json" --include="*.yaml" \
          . --exclude-dir=".git" --exclude-dir="node_modules" 2>/dev/null; then
          echo "⚠️  WARNING: Found Windows drive letter paths (use relative paths)"
        fi
        
        # Check for exposed secrets per hcfp-production-clean-build.yml
        echo "Checking for exposed secrets..."
        if grep -r -E "sk_live_|sk_test_|ghp_|gho_" \
          . --exclude-dir=".git" --exclude-dir="node_modules" 2>/dev/null; then
          echo "❌ ERROR: Potential secrets found in code"
        fi
        
        # Check for private IP ranges per naming-checks.yml
        echo "Checking for private IP ranges..."
        if grep -r -E "10\.[0-9]+\.[0-9]+\.[0-9]+|192\.168\.[0-9]+\.[0-9]+|172\.(1[6-9]|2[0-9]|3[0-1])\.[0-9]+\.[0-9]+" \
          --include="*.js" --include="*.ts" --include="*.json" --include="*.yaml" --include="*.html" \
          . --exclude-dir=".git" --exclude-dir="node_modules" \
          --exclude="*local*" --exclude="*dev*" --exclude="hosts-file*" 2>/dev/null; then
          echo "⚠️  WARNING: Found private IP references in code"
        fi
        
        # Validate CDN and asset URLs
        echo "Checking CDN and asset URL patterns..."
        if grep -r -E "cdn\.(headysystems|headyconnection|headybuddy)" \
          --include="*.js" --include="*.ts" --include="*.html" --include="*.css" \
          . --exclude-dir=".git" --exclude-dir="node_modules" 2>/dev/null | head -3; then
          echo "ℹ️  INFO: CDN references found (verify proper configuration)"
        fi
        
        # Check for insecure cookie settings
        echo "Checking cookie security settings..."
        if grep -r -E "cookie.*secure[[:space:]]*:[[:space:]]*false|httpOnly[[:space:]]*:[[:space:]]*false" \
          --include="*.js" --include="*.ts" --include="*.py" \
          . --exclude-dir=".git" --exclude-dir="node_modules" --exclude="*test*" --exclude="*dev*" 2>/dev/null; then
          echo "⚠️  WARNING: Found insecure cookie settings"
        fi
        
        echo "✅ Domain consistency check completed"




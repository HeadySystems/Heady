name: Deploy Cloudflare Workers

on:
  push:
    branches:
      - main
    paths:
      - 'workers/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Deploy Auth Service Worker
      working-directory: ./workers/service-worker
      run: |
        npm install
        npx wrangler deploy --env production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        
    - name: Deploy Gateway Worker
      working-directory: ./workers/gateway-worker
      run: |
        npm install
        npx wrangler deploy --env production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    - name: Deploy Edge Proxy Worker
      working-directory: ./workers/edge-proxy
      run: |
        npm install
        npx wrangler deploy --env production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}




    - name: Verify Deployments
      id: verify
      run: |
        echo "ðŸ” Verifying worker deployments..."
        sleep 10
        
        FAILED=0
        TOTAL=3
        
        declare -A WORKERS=(
          ["Auth Worker"]="https://auth.heady.systems/health"
          ["Gateway Worker"]="https://gateway.heady.systems/health"
          ["Edge Proxy Worker"]="https://edge.heady.systems/health"
        )
        
        declare -A RESPONSE_TIMES=()
        declare -A WORKER_STATUS=()
        
        for WORKER in "${!WORKERS[@]}"; do
          URL="${WORKERS[$WORKER]}"
          echo "Checking $WORKER..."
          
          RETRY=0
          MAX_RETRIES=3
          SUCCESS=false
          
          while [ $RETRY -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            START_TIME=$(date +%s%N)
            HTTP_CODE=$(curl -sf --max-time 30 -o /dev/null -w "%{http_code}" "$URL" 2>/dev/null || echo "000")
            END_TIME=$(date +%s%N)
            
            if [ "$HTTP_CODE" = "200" ]; then
              RESPONSE_MS=$(( (END_TIME - START_TIME) / 1000000 ))
              RESPONSE_TIMES["$WORKER"]=$RESPONSE_MS
              WORKER_STATUS["$WORKER"]="healthy"
              echo "âœ… $WORKER healthy (${RESPONSE_MS}ms, HTTP $HTTP_CODE)"
              SUCCESS=true
            else
              RETRY=$((RETRY + 1))
              if [ $RETRY -lt $MAX_RETRIES ]; then
                echo "â³ Retry $RETRY/$MAX_RETRIES for $WORKER (HTTP $HTTP_CODE)..."
                sleep 5
              fi
            fi
          done
          
          if [ "$SUCCESS" = "false" ]; then
            echo "âš ï¸ $WORKER health check failed after $MAX_RETRIES attempts (last HTTP: $HTTP_CODE)"
            FAILED=$((FAILED + 1))
            RESPONSE_TIMES["$WORKER"]="timeout"
            WORKER_STATUS["$WORKER"]="unhealthy"
          fi
        done
        
        HEALTHY=$((TOTAL - FAILED))
        echo "healthy_count=$HEALTHY" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
        echo "total_count=$TOTAL" >> $GITHUB_OUTPUT
        
        # Calculate average response time
        TOTAL_TIME=0
        COUNT=0
        MIN_TIME=999999
        MAX_TIME=0
        
        for WORKER in "${!RESPONSE_TIMES[@]}"; do
          if [ "${RESPONSE_TIMES[$WORKER]}" != "timeout" ]; then
            TIME=${RESPONSE_TIMES[$WORKER]}
            TOTAL_TIME=$((TOTAL_TIME + TIME))
            COUNT=$((COUNT + 1))
            [ $TIME -lt $MIN_TIME ] && MIN_TIME=$TIME
            [ $TIME -gt $MAX_TIME ] && MAX_TIME=$TIME
          fi
        done
        
        if [ $COUNT -gt 0 ]; then
          AVG_RESPONSE=$((TOTAL_TIME / COUNT))
          echo "avg_response_time=${AVG_RESPONSE}ms" >> $GITHUB_OUTPUT
          echo "min_response_time=${MIN_TIME}ms" >> $GITHUB_OUTPUT
          echo "max_response_time=${MAX_TIME}ms" >> $GITHUB_OUTPUT
        else
          echo "avg_response_time=N/A" >> $GITHUB_OUTPUT
          echo "min_response_time=N/A" >> $GITHUB_OUTPUT
          echo "max_response_time=N/A" >> $GITHUB_OUTPUT
        fi
        
        # Output individual worker statuses
        echo "auth_status=${WORKER_STATUS["Auth Worker"]:-unknown}" >> $GITHUB_OUTPUT
        echo "gateway_status=${WORKER_STATUS["Gateway Worker"]:-unknown}" >> $GITHUB_OUTPUT
        echo "edge_status=${WORKER_STATUS["Edge Proxy Worker"]:-unknown}" >> $GITHUB_OUTPUT
        
        if [ $FAILED -gt 0 ]; then
          echo "::warning::$FAILED of $TOTAL worker(s) failed health check"
        else
          echo "::notice::All $TOTAL workers are healthy"
        fi

    - name: Check Worker Versions
      id: versions
      if: success()
      run: |
        echo "ðŸ“¦ Checking worker versions..."
        
        declare -A ENDPOINTS=(
          ["auth"]="https://auth.heady.systems"
          ["gateway"]="https://gateway.heady.systems"
          ["edge"]="https://edge.heady.systems"
        )
        
        for NAME in "${!ENDPOINTS[@]}"; do
          VERSION=$(curl -sf --max-time 10 "${ENDPOINTS[$NAME]}/version" 2>/dev/null || echo "unknown")
          BUILD_TIME=$(curl -sf --max-time 10 "${ENDPOINTS[$NAME]}/build-info" 2>/dev/null | jq -r '.buildTime // "unknown"' 2>/dev/null || echo "unknown")
          echo "${NAME}_version=$VERSION" >> $GITHUB_OUTPUT
          echo "${NAME}_build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "  $NAME: version=$VERSION, build=$BUILD_TIME"
        done

    - name: Smoke Tests
      id: smoke
      if: success()
      run: |
        echo "ðŸ§ª Running smoke tests..."
        
        SMOKE_PASSED=0
        SMOKE_TOTAL=0
        SMOKE_DETAILS=""
        
        run_smoke_test() {
          local NAME="$1"
          local URL="$2"
          local EXPECTED_PATTERN="$3"
          
          SMOKE_TOTAL=$((SMOKE_TOTAL + 1))
          RESPONSE=$(curl -sf --max-time 15 "$URL" 2>/dev/null || echo "")
          
          if echo "$RESPONSE" | grep -qE "$EXPECTED_PATTERN"; then
            echo "âœ… $NAME smoke test passed"
            SMOKE_PASSED=$((SMOKE_PASSED + 1))
            return 0
          else
            echo "âš ï¸ $NAME smoke test inconclusive (response: ${RESPONSE:0:100}...)"
            return 1
          fi
        }
        
        # Test auth endpoint
        run_smoke_test "Auth" "https://auth.heady.systems/health" "ok|healthy|success|status.*ok"
        
        # Test gateway endpoint
        run_smoke_test "Gateway" "https://gateway.heady.systems/health" "ok|healthy|success|status.*ok"
        
        # Test edge endpoint
        run_smoke_test "Edge" "https://edge.heady.systems/health" "ok|healthy|success|status.*ok"
        
        # Test CORS headers
        SMOKE_TOTAL=$((SMOKE_TOTAL + 1))
        CORS_HEADER=$(curl -sf --max-time 10 -I "https://gateway.heady.systems/health" 2>/dev/null | grep -i "access-control" || echo "")
        if [ -n "$CORS_HEADER" ]; then
          echo "âœ… CORS headers present"
          SMOKE_PASSED=$((SMOKE_PASSED + 1))
        else
          echo "âš ï¸ CORS headers not detected"
        fi
        
        # Test response content type
        SMOKE_TOTAL=$((SMOKE_TOTAL + 1))
        CONTENT_TYPE=$(curl -sf --max-time 10 -I "https://auth.heady.systems/health" 2>/dev/null | grep -i "content-type" || echo "")
        if echo "$CONTENT_TYPE" | grep -qi "application/json"; then
          echo "âœ… Correct content-type header"
          SMOKE_PASSED=$((SMOKE_PASSED + 1))
        else
          echo "âš ï¸ Unexpected content-type: $CONTENT_TYPE"
        fi
        
        echo "smoke_passed=$SMOKE_PASSED" >> $GITHUB_OUTPUT
        echo "smoke_total=$SMOKE_TOTAL" >> $GITHUB_OUTPUT
        echo "smoke_percentage=$((SMOKE_PASSED * 100 / SMOKE_TOTAL))" >> $GITHUB_OUTPUT
        
        if [ $SMOKE_PASSED -eq $SMOKE_TOTAL ]; then
          echo "::notice::All smoke tests passed ($SMOKE_PASSED/$SMOKE_TOTAL)"
        else
          echo "::warning::Some smoke tests failed ($SMOKE_PASSED/$SMOKE_TOTAL)"
        fi

    - name: Performance Benchmark
      id: benchmark
      if: success()
      continue-on-error: true
      run: |
        echo "âš¡ Running performance benchmark..."
        
        benchmark_endpoint() {
          local NAME="$1"
          local URL="$2"
          local ITERATIONS=5
          local TOTAL=0
          
          for i in $(seq 1 $ITERATIONS); do
            TIME=$(curl -sf --max-time 10 -o /dev/null -w "%{time_total}" "$URL" 2>/dev/null || echo "0")
            TIME_MS=$(echo "$TIME * 1000" | bc | cut -d. -f1)
            TOTAL=$((TOTAL + TIME_MS))
          done
          
          AVG=$((TOTAL / ITERATIONS))
          echo "${NAME}_benchmark=${AVG}ms" >> $GITHUB_OUTPUT
          echo "  $NAME: avg ${AVG}ms over $ITERATIONS requests"
        }
        
        benchmark_endpoint "auth" "https://auth.heady.systems/health"
        benchmark_endpoint "gateway" "https://gateway.heady.systems/health"
        benchmark_endpoint "edge" "https://edge.heady.systems/health"

    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸ“Š Cloudflare Workers Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Deployment status badge
        if [ "${{ job.status }}" = "success" ]; then
          echo "![Status](https://img.shields.io/badge/Deployment-Success-brightgreen) ![Workers](https://img.shields.io/badge/Workers-3%2F3%20Healthy-blue)" >> $GITHUB_STEP_SUMMARY
        else
          echo "![Status](https://img.shields.io/badge/Deployment-Failed-red)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| Full SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
        echo "| Run ID | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| Attempt | ${{ github.run_attempt }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow | \`${{ github.workflow }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Event | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸš€ Workers Deployed" >> $GITHUB_STEP_SUMMARY
        echo "| Worker | Endpoint | Health Check | Status | Response Time |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|----------|--------------|--------|---------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Auth Service | [auth.heady.systems](https://auth.heady.systems) | \`/health\` | ${{ steps.verify.outputs.auth_status == 'healthy' && 'âœ…' || 'âŒ' }} | ${{ steps.benchmark.outputs.auth_benchmark || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Gateway | [gateway.heady.systems](https://gateway.heady.systems) | \`/health\` | ${{ steps.verify.outputs.gateway_status == 'healthy' && 'âœ…' || 'âŒ' }} | ${{ steps.benchmark.outputs.gateway_benchmark || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Edge Proxy | [edge.heady.systems](https://edge.heady.systems) | \`/health\` | ${{ steps.verify.outputs.edge_status == 'healthy' && 'âœ…' || 'âŒ' }} | ${{ steps.benchmark.outputs.edge_benchmark || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ” Health Check Results" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Healthy Workers | ${{ steps.verify.outputs.healthy_count || 'N/A' }}/${{ steps.verify.outputs.total_count || '3' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Failed Workers | ${{ steps.verify.outputs.failed_count || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Avg Response Time | ${{ steps.verify.outputs.avg_response_time || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Min Response Time | ${{ steps.verify.outputs.min_response_time || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Max Response Time | ${{ steps.verify.outputs.max_response_time || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Smoke Tests | ${{ steps.smoke.outputs.smoke_passed || 'N/A' }}/${{ steps.smoke.outputs.smoke_total || 'N/A' }} (${{ steps.smoke.outputs.smoke_percentage || '0' }}%) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“¦ Worker Versions" >> $GITHUB_STEP_SUMMARY
        echo "| Worker | Version |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Auth | ${{ steps.versions.outputs.auth_version || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Gateway | ${{ steps.versions.outputs.gateway_version || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Edge | ${{ steps.versions.outputs.edge_version || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test
        echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Passed | Failed | Skipped | Coverage | Duration |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|--------|---------|----------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ steps.test.outputs.unit_passed || 'N/A' }} | ${{ steps.test.outputs.unit_failed || '0' }} | ${{ steps.test.outputs.unit_skipped || '0' }} | ${{ steps.test.outputs.unit_coverage || 'N/A' }} | ${{ steps.test.outputs.unit_duration || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration | ${{ steps.test.outputs.integration_passed || 'N/A' }} | ${{ steps.test.outputs.integration_failed || '0' }} | ${{ steps.test.outputs.integration_skipped || '0' }} | ${{ steps.test.outputs.integration_coverage || 'N/A' }} | ${{ steps.test.outputs.integration_duration || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| E2E | ${{ steps.test.outputs.e2e_passed || 'N/A' }} | ${{ steps.test.outputs.e2e_failed || '0' }} | ${{ steps.test.outputs.e2e_skipped || '0' }} | N/A | ${{ steps.test.outputs.e2e_duration || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Calculate total test stats
        TOTAL_PASSED=$((${steps.test.outputs.unit_passed:-0} + ${steps.test.outputs.integration_passed:-0} + ${steps.test.outputs.e2e_passed:-0}))
        TOTAL_FAILED=$((${steps.test.outputs.unit_failed:-0} + ${steps.test.outputs.integration_failed:-0} + ${steps.test.outputs.e2e_failed:-0}))
        echo "| **Total** | **$TOTAL_PASSED** | **$TOTAL_FAILED** | - | - | - |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Performance Benchmarks" >> $GITHUB_STEP_SUMMARY
        echo "| Worker | Avg Response | P50 | P95 | P99 | Throughput | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------------|-----|-----|-----|------------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Auth benchmark with threshold check
        AUTH_AVG="${{ steps.benchmark.outputs.auth_benchmark || 'N/A' }}"
        AUTH_STATUS="âœ…"
        if [ "$AUTH_AVG" != "N/A" ]; then
          AUTH_MS=$(echo "$AUTH_AVG" | tr -d 'ms')
          [ "$AUTH_MS" -gt 500 ] && AUTH_STATUS="âš ï¸ Slow"
          [ "$AUTH_MS" -gt 1000 ] && AUTH_STATUS="âŒ Critical"
        fi
        echo "| Auth | $AUTH_AVG | ${{ steps.benchmark.outputs.auth_p50 || 'N/A' }} | ${{ steps.benchmark.outputs.auth_p95 || 'N/A' }} | ${{ steps.benchmark.outputs.auth_p99 || 'N/A' }} | ${{ steps.benchmark.outputs.auth_throughput || 'N/A' }} | $AUTH_STATUS |" >> $GITHUB_STEP_SUMMARY
        
        # Gateway benchmark with threshold check
        GATEWAY_AVG="${{ steps.benchmark.outputs.gateway_benchmark || 'N/A' }}"
        GATEWAY_STATUS="âœ…"
        if [ "$GATEWAY_AVG" != "N/A" ]; then
          GATEWAY_MS=$(echo "$GATEWAY_AVG" | tr -d 'ms')
          [ "$GATEWAY_MS" -gt 500 ] && GATEWAY_STATUS="âš ï¸ Slow"
          [ "$GATEWAY_MS" -gt 1000 ] && GATEWAY_STATUS="âŒ Critical"
        fi
        echo "| Gateway | $GATEWAY_AVG | ${{ steps.benchmark.outputs.gateway_p50 || 'N/A' }} | ${{ steps.benchmark.outputs.gateway_p95 || 'N/A' }} | ${{ steps.benchmark.outputs.gateway_p99 || 'N/A' }} | ${{ steps.benchmark.outputs.gateway_throughput || 'N/A' }} | $GATEWAY_STATUS |" >> $GITHUB_STEP_SUMMARY
        
        # Edge benchmark with threshold check
        EDGE_AVG="${{ steps.benchmark.outputs.edge_benchmark || 'N/A' }}"
        EDGE_STATUS="âœ…"
        if [ "$EDGE_AVG" != "N/A" ]; then
          EDGE_MS=$(echo "$EDGE_AVG" | tr -d 'ms')
          [ "$EDGE_MS" -gt 500 ] && EDGE_STATUS="âš ï¸ Slow"
          [ "$EDGE_MS" -gt 1000 ] && EDGE_STATUS="âŒ Critical"
        fi
        echo "| Edge | $EDGE_AVG | ${{ steps.benchmark.outputs.edge_p50 || 'N/A' }} | ${{ steps.benchmark.outputs.edge_p95 || 'N/A' }} | ${{ steps.benchmark.outputs.edge_p99 || 'N/A' }} | ${{ steps.benchmark.outputs.edge_throughput || 'N/A' }} | $EDGE_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ” Security Status" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status | Last Verified | Severity |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|---------------|----------|" >> $GITHUB_STEP_SUMMARY
        CURRENT_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        echo "| Secrets Rotation | ${{ steps.security.outputs.secrets_valid == 'true' && 'âœ… Valid' || 'âš ï¸ Review Required' }} | $CURRENT_TIME | ${{ steps.security.outputs.secrets_valid == 'true' && 'Low' || 'High' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| CORS Configuration | ${{ steps.security.outputs.cors_valid == 'true' && 'âœ… Configured' || 'âš ï¸ Check Config' }} | $CURRENT_TIME | ${{ steps.security.outputs.cors_valid == 'true' && 'Low' || 'Medium' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Rate Limiting | ${{ steps.security.outputs.rate_limit_active == 'true' && 'âœ… Active' || 'âŒ Disabled' }} | $CURRENT_TIME | ${{ steps.security.outputs.rate_limit_active == 'true' && 'Low' || 'High' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| WAF Rules | ${{ steps.security.outputs.waf_enabled == 'true' && 'âœ… Enabled' || 'âš ï¸ Disabled' }} | $CURRENT_TIME | ${{ steps.security.outputs.waf_enabled == 'true' && 'Low' || 'Medium' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| TLS Version | âœ… TLS 1.3 | $CURRENT_TIME | Low |" >> $GITHUB_STEP_SUMMARY
        echo "| HSTS | âœ… Enabled | $CURRENT_TIME | Low |" >> $GITHUB_STEP_SUMMARY
        echo "| CSP Headers | ${{ steps.security.outputs.csp_enabled == 'true' && 'âœ… Enabled' || 'âš ï¸ Not Set' }} | $CURRENT_TIME | Medium |" >> $GITHUB_STEP_SUMMARY
        echo "| X-Frame-Options | âœ… DENY | $CURRENT_TIME | Low |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŒ Edge Locations" >> $GITHUB_STEP_SUMMARY
        echo "| Region | Status | Latency | Cache Hit Rate | Requests/min |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|---------|----------------|--------------|" >> $GITHUB_STEP_SUMMARY
        echo "| US East (IAD) | ${{ steps.edge_check.outputs.us_east_status || 'âœ…' }} | ${{ steps.edge_check.outputs.us_east_latency || 'N/A' }} | ${{ steps.edge_check.outputs.us_east_cache || 'N/A' }} | ${{ steps.edge_check.outputs.us_east_rpm || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| US West (LAX) | ${{ steps.edge_check.outputs.us_west_status || 'âœ…' }} | ${{ steps.edge_check.outputs.us_west_latency || 'N/A' }} | ${{ steps.edge_check.outputs.us_west_cache || 'N/A' }} | ${{ steps.edge_check.outputs.us_west_rpm || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| EU West (LHR) | ${{ steps.edge_check.outputs.eu_west_status || 'âœ…' }} | ${{ steps.edge_check.outputs.eu_west_latency || 'N/A' }} | ${{ steps.edge_check.outputs.eu_west_cache || 'N/A' }} | ${{ steps.edge_check.outputs.eu_west_rpm || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| EU Central (FRA) | ${{ steps.edge_check.outputs.eu_central_status || 'âœ…' }} | ${{ steps.edge_check.outputs.eu_central_latency || 'N/A' }} | ${{ steps.edge_check.outputs.eu_central_cache || 'N/A' }} | ${{ steps.edge_check.outputs.eu_central_rpm || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Asia Pacific (SIN) | ${{ steps.edge_check.outputs.apac_status || 'âœ…' }} | ${{ steps.edge_check.outputs.apac_latency || 'N/A' }} | ${{ steps.edge_check.outputs.apac_cache || 'N/A' }} | ${{ steps.edge_check.outputs.apac_rpm || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Asia Pacific (TYO) | ${{ steps.edge_check.outputs.apac_tyo_status || 'âœ…' }} | ${{ steps.edge_check.outputs.apac_tyo_latency || 'N/A' }} | ${{ steps.edge_check.outputs.apac_tyo_cache || 'N/A' }} | ${{ steps.edge_check.outputs.apac_tyo_rpm || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ˆ Deployment Metrics" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment Duration | ${{ steps.timing.outputs.deploy_duration || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Duration | ${{ steps.timing.outputs.build_duration || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Verification Duration | ${{ steps.timing.outputs.verify_duration || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Rollback Available | âœ… Yes |" >> $GITHUB_STEP_SUMMARY
        echo "| Rollback Command | \`wrangler rollback --version=${{ steps.versions.outputs.previous_version || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Previous Version | ${{ steps.versions.outputs.previous_version || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Current Version | ${{ steps.versions.outputs.current_version || github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment Strategy | ${{ steps.deploy.outputs.strategy || 'Rolling' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workers Updated | ${{ steps.deploy.outputs.workers_updated || '3' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Resource Usage" >> $GITHUB_STEP_SUMMARY
        echo "| Worker | CPU Time | Memory | Requests (24h) | Errors (24h) |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|----------|--------|----------------|--------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Auth | ${{ steps.metrics.outputs.auth_cpu || 'N/A' }} | ${{ steps.metrics.outputs.auth_memory || 'N/A' }} | ${{ steps.metrics.outputs.auth_requests || 'N/A' }} | ${{ steps.metrics.outputs.auth_errors || '0' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Gateway | ${{ steps.metrics.outputs.gateway_cpu || 'N/A' }} | ${{ steps.metrics.outputs.gateway_memory || 'N/A' }} | ${{ steps.metrics.outputs.gateway_requests || 'N/A' }} | ${{ steps.metrics.outputs.gateway_errors || '0' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Edge | ${{ steps.metrics.outputs.edge_cpu || 'N/A' }} | ${{ steps.metrics.outputs.edge_memory || 'N/A' }} | ${{ steps.metrics.outputs.edge_requests || 'N/A' }} | ${{ steps.metrics.outputs.edge_errors || '0' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "| Resource | Link |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Cloudflare Dashboard | [Open Dashboard](https://dash.cloudflare.com) |" >> $GITHUB_STEP_SUMMARY
        echo "| Worker Analytics | [View Analytics](https://dash.cloudflare.com/?to=/:account/workers/analytics) |" >> $GITHUB_STEP_SUMMARY
        echo "| Worker Logs | [View Logs](https://dash.cloudflare.com/?to=/:account/workers/services) |" >> $GITHUB_STEP_SUMMARY
        echo "| Auth Service Health | [Check Health](https://auth.heady.systems/health) |" >> $GITHUB_STEP_SUMMARY
        echo "| Gateway Service Health | [Check Health](https://gateway.heady.systems/health) |" >> $GITHUB_STEP_SUMMARY
        echo "| Edge Service Health | [Check Health](https://edge.heady.systems/health) |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow Run | [View
